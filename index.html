<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Проверка возвратных заказов</title>
<meta name="viewport" content="width=700, initial-scale=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #1a2340;}
.section { background: #fff; border-radius: 18px; box-shadow: 0 4px 32px 0 #dae5fa22; padding: 24px 30px; margin: 0 auto 30px auto; max-width: 690px;}
label { font-size: 1.09em; display: block; margin-top: 16px; }
input[type="text"], textarea, input[type="date"] { font-size: 1em; border-radius:6px; border:1.5px solid #cdd6e6; margin-top:5px; margin-bottom:0; padding:8px 10px; background: #fafdff; width: 100%; box-sizing: border-box;}
textarea { min-height: 44px;}
.flex-row {display: flex; gap: 20px; margin-top:6px;margin-bottom:2px}
button, .btn {margin-top:22px;font-size:1.1em; border:none;background:linear-gradient(90deg,#0076ec 60%,#22b8cf 100%); color:#fff; padding:12px 40px; border-radius: 9px; font-weight:600;}
button:hover, .btn:hover { background:#015a9f; }
#modal {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,34,80,0.26);justify-content:center;align-items:center;z-index:9999}
#modal .modal-inner { background: linear-gradient(150deg, #ffe666 68%, #ffd028 103%); color: #361800; padding: 42px 45px 30px 45px; min-width:330px; max-width:400px; border-radius: 17px; box-shadow: 0 7px 34px 0 rgba(90,66,2,0.14); font-size: 1.21em;font-weight: 600;text-align:center; border:2.5px solid #FFEE95;}
#modal .modal-inner button { background: #fffbe0; border: 2px solid #ffc400; color: #e79114; font-size:1.07em; padding: 8px 31px; border-radius:9px; margin:15px 5px 0 5px;}
#modal .modal-inner button:hover {background:#ffe178;}
</style>
</head>
<body>
<h2>Проверка возвратных заказов</h2>
<div id="modal"><div class="modal-inner">
  <span id="modalText"></span><br>
  <button type="button" onclick="closeModal(true)">Понятно</button>
  <button type="button" onclick="closeModal(false)">Отмена</button>
</div></div>
<div class="section">
  <form id="manualForm" autocomplete="off">
    <label>Номер заказа:<input id="Номер заказа" type="text" required></label>
    <label>Номер клиентского возврата:<input id="Номер клиентского возврата" type="text" required></label>
    <label>Название СД:<input id="Название СД" type="text" required></label>
    <label>Название магазина:<input id="Название магазина" type="text" required></label>
    <label>Содержимое заказа:<textarea id="Содержимое заказа" required></textarea></label>
    <label>Причина возврата от клиента:<textarea id="Причина возврата от клиента"></textarea></label>

    <label>Вскрыта товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    <label>Повреждена товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    <label>Повреждение товара?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждение товара?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждение товара?" value="Нет" required>Нет</label>
    </div>
    <label>Товар БУ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Товар БУ?" value="Да" required>Да</label>
      <label><input type="radio" name="Товар БУ?" value="Нет" required>Нет</label>
    </div>
    <label>Фактический размер:<input id="Фактический размер" type="text"></label>
    <label>Комментарии по возврату:<textarea id="Комментарии по возврату"></textarea></label>
    <label>Дата проверки:<input id="Дата проверки" type="date" required></label>
    <div id="peresortBlock">
      <label>Пересорт:</label>
      <div class="flex-row">
        <label><input type="radio" name="Пересорт" value="Да" required>Да</label>
        <label><input type="radio" name="Пересорт" value="Нет" required>Нет</label>
      </div>
    </div>
    <div id="nrpBlock">
      <label>Есть акт нрп? <span style="color:#e35d00;font-weight: bold">*</span></label>
      <div class="flex-row">
        <label><input type="radio" name="Есть акт нрп?" value="Да" required>Да</label>
        <label><input type="radio" name="Есть акт нрп?" value="Нет" required>Нет</label>
      </div>
    </div>
    <label>Отправляем в АСЦ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Отправляем в АСЦ?" value="Да" required>Да</label>
      <label><input type="radio" name="Отправляем в АСЦ?" value="Нет" required>Нет</label>
    </div>
    <div id="serialBlock" style="display:none">
      <label>Серийный номер:<input id="Серийный номер" type="text"></label>
    </div>
    <label>Шк товара:<input id="Шк товара" type="text" required></label>
    <label>Результат проверки:<input id="Результат проверки" type="text"></label>
    <button type="submit" class="btn">Проверить заказ и СОХРАНИТЬ</button>
  </form>
</div>
<div class="section">
  <h4>Массовая загрузка (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>
<script>
let loadedOrders = [];
// ---- mass-upload по шапке! ----
document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    let text = evt.target.result;
    let delimiter='\t';
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    const headers = lines[0].split(delimiter).map(h => h.trim());
    loadedOrders = [];
    let html = '<table id="csvOrdersTable"><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
    for(let i=1; i<lines.length; i++) {
      const row=lines[i].split(delimiter);
      while(row.length<headers.length)row.push('');
      html+=`<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      let order = {};
      for(let j=0; j<headers.length; j++) {
        order[headers[j]] = row[j].trim();
      }
      loadedOrders.push(order);
    }
    html += '</table>';
    document.getElementById('csvOrders').innerHTML = html;
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick = function(){
        const idx = +this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx]);
      }
    });
  };
  reader.readAsText(file, 'utf-8');
});
// ----- автозаполнение -----
function fillOrderFromCSV(order) {
  Object.keys(order).forEach(function(key) {
    var el = document.getElementById(key);
    if (el) el.value = order[key];
  });
}
// ----- ручной ввод тоже автозаполняет при совпадении -----
let autofillLock = false;
function tryAutoFillForm() {
  if(autofillLock)return;
  const num = document.getElementById('Номер заказа').value.trim();
  const ret = document.getElementById('Номер клиентского возврата').value.trim();
  if(!num&&!ret)return;
  let order = loadedOrders.find(order =>
    (num && norm(order["Номер заказа"]) === norm(num)) ||
    (ret && norm(order["Номер клиентского возврата"]) === norm(ret))
  );
  if (!order) return;
  autofillLock=true;
  fillOrderFromCSV(order);
  autofillLock=false;
}
['input','change'].forEach(ev=>{
  document.getElementById('Номер заказа').addEventListener(ev,tryAutoFillForm);
  document.getElementById('Номер клиентского возврата').addEventListener(ev,tryAutoFillForm);
});
// ----- радиокнопки/required динамически -----
function getRadio(name) {
  let e = document.querySelector('input[name="'+name+'"]:checked');
  return e ? e.value.trim() : "";
}
function showModal(msg,cb){
  document.getElementById('modalText').textContent=msg;
  document.getElementById('modal').style.display="flex";
  closeModal.cb=cb;
}
function closeModal(confirm){
  document.getElementById('modal').style.display="none";
  if(confirm&&typeof closeModal.cb==="function"){closeModal.cb();}
  closeModal.cb=null;
}
async function submitAndSave(){
  const data = {
    "Номер заказа": document.getElementById('Номер заказа').value,
    "Номер клиентского возврата": document.getElementById('Номер клиентского возврата').value,
    "Название СД": document.getElementById('Название СД').value,
    "Название магазина": document.getElementById('Название магазина').value,
    "Содержимое заказа": document.getElementById('Содержимое заказа').value,
    "Причина возврата от клиента": document.getElementById('Причина возврата от клиента').value,
    "Вскрыта товарная упаковка?": getRadio('Вскрыта товарная упаковка?'),
    "Повреждена товарная упаковка?": getRadio('Повреждена товарная упаковка?'),
    "Повреждение товара?": getRadio('Повреждение товара?'),
    "Товар БУ?": getRadio('Товар БУ?'),
    "Фактический размер": document.getElementById('Фактический размер').value,
    "Комментарии по возврату": document.getElementById('Комментарии по возврату').value,
    "Дата проверки": document.getElementById('Дата проверки').value,
    "Тикет/акт": "",
    "Есть акт нрп?": getRadio('Есть акт нрп?'),
    "Пересорт": getRadio("Пересорт"),
    "Отправляем в АСЦ?": getRadio("Отправляем в АСЦ?"),
    "Серийный номер": document.getElementById('Серийный номер') ? document.getElementById('Серийный номер').value : '',
    "Шк товара": document.getElementById('Шк товара').value,
    "Результат проверки": document.getElementById('Результат проверки').value
  };
  try {
    const resp = await fetch(
      "https://heck-evsc.onrender.com/proxy",
      {
        method: "POST",
        body: JSON.stringify(data),
        headers: {"Content-Type": "application/json"}
      }
    );
    const txt = await resp.text();
    if(resp.ok && txt.includes("OK")){
      alert("✅ Сохранено!"); document.getElementById('manualForm').reset();
    }else{
      alert("❌ Ошибка при сохранении: "+txt);
    }
  }catch(err){
    alert("❌ Ошибка связи с прокси-сервером");
  }
}
document.getElementById('manualForm').onsubmit = function(e) {
  e.preventDefault();
  // ... вызови модалки если необходимо ...
  submitAndSave();
  return false;
};
</script>
</body>
</html>
