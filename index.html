<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Проверка возвратных заказов</title>
<style>
body { font-family: Arial, sans-serif; padding: 15px; max-width: 700px; margin: auto; }
label { display: block; margin-top: 10px; }
.section { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; }
.flex-row { display: flex; gap: 10px; }
input[type="text"], textarea { width: 100%; }
input[type="date"] { width: 50%; }
textarea { min-height: 60px; }
button { margin-top: 10px; }
#csvOrdersTable { margin-top:12px; border-collapse: collapse; width:100%; }
#csvOrdersTable tr { cursor:pointer; transition: background 0.2s; }
#csvOrdersTable tr:hover { background: #eef; }
#csvOrdersTable th, #csvOrdersTable td { border:1px solid #bbb; padding:6px 8px; }
#modal {
  display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.32); justify-content: center; align-items: center; z-index: 9999;
}
#modal .modal-inner {
  background: linear-gradient(150deg, #FFD600 70%, #FF9100 100%);
  color: #291e03;
  padding: 44px 54px 30px 54px;
  border-radius: 16px;
  box-shadow: 0 12px 38px 0 rgba(0,0,0,0.15);
  font-size: 1.35em;
  font-weight: bold;
  text-align: center;
  border: 3px solid #FFF59D;
}
#modal .modal-inner button {
  background: #fffde7;
  border: 2px solid #FF9100;
  color: #FF6D00;
  font-size:1.1em;padding: 8px 35px;
  border-radius: 8px;
  margin:12px 7px 0 7px;font-weight: bold;
  cursor:pointer;
  transition:background .15s;
}
#modal .modal-inner button:hover {
  background:#ffecb3;
}
</style>
</head>
<body>
<h2>Проверка возвратных заказов</h2>

<div id="modal">
  <div class="modal-inner">
    <span id="modalText"></span><br>
    <button id="modal-confirm-btn" onclick="closeModal(true)">Понятно</button>
    <button id="modal-cancel-btn" onclick="closeModal(false)">Отмена</button>
  </div>
</div>

<div class="section">
  <form id="manualForm" autocomplete="off">
    <label>Название СД:<input type="text" id="sdName" required></label>
    <label>Название магазина:<input type="text" id="storeName" required></label>
    <label>Номер заказ:<input type="text" id="orderNum" required></label>
    <label>Номер клиентского возврат:<input type="text" id="clientReturnNum" required></label>
    <label>Содержимое заказа:<textarea id="orderContent" required></textarea></label>
    <label>Причина возврата от клиента:<textarea id="returnReason"></textarea></label>
    <label>Вскрыта товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingOpened" value="Да" required>Да</label>
      <label><input type="radio" name="packingOpened" value="Нет" required>Нет</label>
    </div>
    <label>Повреждена товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingDamaged" value="Да" required>Да</label>
      <label><input type="radio" name="packingDamaged" value="Нет" required>Нет</label>
    </div>
    <label>Повреждение товара?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodDamaged" value="Да" required>Да</label>
      <label><input type="radio" name="goodDamaged" value="Нет" required>Нет</label>
    </div>
    <label>Товар БУ?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodUsed" value="Да" required>Да</label>
      <label><input type="radio" name="goodUsed" value="Нет" required>Нет</label>
    </div>
    <label>Фактический размер:<input type="text" id="actualSize"></label>
    <label>Комментарии по возврату:<textarea id="comment"></textarea></label>
    <label>Дата проверки:<input type="date" id="dateChecked" required></label>
    <div id="ticketBlock" style="display:none">
      <label>Тикет/акт:<input type="text" id="ticket"></label>
    </div>
    <label>Пересорт:</label>
    <div class="flex-row">
      <label><input type="radio" name="peresort" value="Да" required>Да</label>
      <label><input type="radio" name="peresort" value="Нет" required>Нет</label>
    </div>
    <label>Отправляем в АСЦ?</label>
    <div class="flex-row">
      <label><input type="radio" name="toASC" value="Да" required>Да</label>
      <label><input type="radio" name="toASC" value="Нет" required>Нет</label>
    </div>
    <div id="serialBlock" style="display:none">
      <label>Серийный номер:<input type="text" id="serialNum"></label>
    </div>
    <label>Шк товара:<input type="text" id="barcode" required></label>
    <label>Результат проверки:<input type="text" id="orderResult"></label>
    <button type="submit">Проверить заказ и СОХРАНИТЬ</button>
  </form>
  <div id="msg"></div>
</div>

<div class="section">
  <h4>Массовая загрузка (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>

<script>
let loadedOrders = [];
function norm(val) { return (val||'').replace(/\s/g, '').toLowerCase(); }

function lookupOrder() {
  const num = document.getElementById('orderNum').value;
  const ret = document.getElementById('clientReturnNum').value;
  if (!num && !ret) return null;
  let order = null;
  if (num) order = loadedOrders.find(o => norm(o.orderNum) === norm(num));
  if (!order && ret) order = loadedOrders.find(o => norm(o.clientReturnNum) === norm(ret));
  return order || null;
}

let autofillLock = false;
function tryAutoFillForm() {
  if (autofillLock) return;
  const order = lookupOrder();
  if (!order) return;
  autofillLock = true;
  if (norm(document.getElementById('orderNum').value) !== norm(order.orderNum)) {
    document.getElementById('orderNum').value = order.orderNum || '';
  }
  if (norm(document.getElementById('clientReturnNum').value) !== norm(order.clientReturnNum)) {
    document.getElementById('clientReturnNum').value = order.clientReturnNum || '';
  }
  document.getElementById('orderContent').value = order.orderContent || '';
  document.getElementById('returnReason').value = order.returnReason || '';
  document.getElementById('sdName').value = order.sdName || '';
  document.getElementById('storeName').value = order.storeName || '';
  autofillLock = false;
}
['input', 'change'].forEach(ev=>{
  document.getElementById('orderNum').addEventListener(ev, tryAutoFillForm);
  document.getElementById('clientReturnNum').addEventListener(ev, tryAutoFillForm);
});
function fillOrderFromCSV(order) {
  document.getElementById('orderNum').value = order.orderNum || '';
  document.getElementById('clientReturnNum').value = order.clientReturnNum || '';
  document.getElementById('orderContent').value = order.orderContent || '';
  document.getElementById('returnReason').value = order.returnReason || '';
  document.getElementById('sdName').value = order.sdName || '';
  document.getElementById('storeName').value = order.storeName || '';
}

function detectDelimiter(s) {
  let line = s.split(/\r?\n/)[0];
  if (line.indexOf('\t') !== -1) return '\t';
  if (line.indexOf(';') !== -1) return ';';
  return ',';
}

document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    let text = evt.target.result;
    text = text.split(/\r?\n/).filter(line => line.trim().length>0).join('\n');
    let delimiter = detectDelimiter(text);
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
    const headers = lines[0].split(delimiter).map(h=>h.trim().toLowerCase());
    const idxOrderNum     = headers.findIndex(h=>h === 'номер заказ' || h === 'номер заказа');
    const idxClientReturn = headers.findIndex(h=>h === 'номер клиентского возврат' || h === 'номер клиентского возврата' || h === 'номер клиетского возврата');
    const idxOrderContent = headers.findIndex(h=>h.includes('содержимое заказа'));
    const idxReturnReason = headers.findIndex(h=>h.includes('причина возврата'));
    const idxSdName = headers.findIndex(h=>h.includes('название сд'));
    const idxStoreName = headers.findIndex(h=>h.includes('название магазина'));
    loadedOrders = [];
    let html = '<table id="csvOrdersTable"><tr>' + lines[0].split(delimiter).map(h=>`<th>${h.trim()}</th>`).join('') + '</tr>';
    for (let i=1; i<lines.length; i++) {
      const row = lines[i].split(delimiter);
      while (row.length < headers.length) row.push('');
      html += `<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      loadedOrders.push({
        orderNum: (row[idxOrderNum]||'').trim(),
        clientReturnNum: (row[idxClientReturn]||'').trim(),
        orderContent: (row[idxOrderContent]||'').trim(),
        returnReason: (row[idxReturnReason]||'').trim(),
        sdName: (row[idxSdName]||'').trim(),
        storeName: (row[idxStoreName]||'').trim()
      });
    }
    html += '</table>';
    document.getElementById('csvOrders').innerHTML = html;
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick = function() {
        const idx = +this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx]);
      }
    });
  };
  reader.readAsText(file, 'utf-8');
});

// TODO: динамика для тикета и серийного номера
function updateDynamicFields() {
  // Показывать тикет-акт только если "Пересорт" = "Да"
  let showTicket = getRadio('peresort') === 'да';
  document.getElementById('ticketBlock').style.display = showTicket ? '' : 'none';
  document.getElementById('ticket').required = showTicket;
  // Показывать серийный номер только если "Отправляем в АСЦ" = "Да"
  let showSerial = getRadio('toASC') === 'да';
  document.getElementById('serialBlock').style.display = showSerial ? '' : 'none';
  document.getElementById('serialNum').required = showSerial;
}
['change','input'].forEach(ev=>{
  document.getElementsByName('peresort').forEach(e=>e.addEventListener(ev, updateDynamicFields));
  document.getElementsByName('toASC').forEach(e=>e.addEventListener(ev, updateDynamicFields));
});

//================= МОДАЛКА ==================
function showModal(msg, cb) {
  document.getElementById('modalText').textContent = msg;
  document.getElementById('modal').style.display = "flex";
  closeModal.cb = cb;
}
function closeModal(confirm) {
  document.getElementById('modal').style.display = "none";
  if (confirm && typeof closeModal.cb === "function") {
    closeModal.cb();
  }
  closeModal.cb = null;
}
function getRadio(name){
  let e = document.querySelector('input[name="'+name+'"]:checked');
  return e ? e.value.trim().toLowerCase() : "";
}
//============= ЛОГИКА ВСПЛЫВАЮЩИХ ПОДСКАЗОК =============
document.getElementById('manualForm').onsubmit = function(e) {
  e.preventDefault();
  updateDynamicFields();
  const packingOpened  = getRadio("packingOpened");
  const packingDamaged = getRadio("packingDamaged");
  const goodDamaged    = getRadio("goodDamaged");
  const goodUsed       = getRadio("goodUsed");
  const toASC          = getRadio("toASC");
  const peresort       = getRadio("peresort");

  // 1. Комбинированные:
  if ((packingOpened==="да" && goodUsed==="да") || (packingDamaged==="да" && goodUsed==="да")) {
    showModal("Положи в ячейку БУ", submitAndSave);
    return false;
  }
  // 2. Пересорт
  if (peresort === "да") {
    showModal("Положи в пересорт", submitAndSave);
    return false;
  }
  // 3. Индивидуальные:
  if (toASC === "да") {
    showModal("Положи в АСЦ, после возвращения, определи его в БУ", submitAndSave);
    return false;
  }
  if (goodUsed === "да") {
    showModal("Положи в БУ", submitAndSave);
    return false;
  }
  if (goodDamaged === "да") {
    showModal("Положи в брак", submitAndSave);
    return false;
  }
  if (packingOpened === "да") {
    showModal("Положи в уценку", submitAndSave);
    return false;
  }
  if (packingDamaged === "да") {
    showModal("Положи в уценку", submitAndSave);
    return false;
  }
  // 4. Всё Нет
  if (
    packingOpened === "нет" &&
    packingDamaged === "нет" &&
    goodDamaged === "нет" &&
    goodUsed === "нет" &&
    toASC === "нет" &&
    peresort === "нет"
  ) {
    showModal("Положи в годный", submitAndSave);
    return false;
  }
  submitAndSave();
  return false;
};

//================= TOAST ==================
function showToast(message, type = "info") {
  const colors = {
    success: "#4caf50",
    error: "#f44336",
    info: "#2196f3"
  };
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
      min-width:220px; max-width:350px; margin-bottom:10px;
      padding: 16px 22px; color: #fff; background: ${colors[type]||'#333'};
      border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-size: 1.12em; font-family: inherit; 
      opacity:0; transition: opacity .3s;
      position: fixed; top: 30px; right: 25px; z-index: 13000;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.style.opacity = "1", 80);
  setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(()=>toast.remove(), 400);
  }, 3400);
}

// ============= SUBMIT =================
async function submitAndSave() {
  const data = {
    "Название СД": document.getElementById('sdName').value,
    "Название магазина": document.getElementById('storeName').value,
    "Номер заказ": document.getElementById('orderNum').value,
    "Номер клиентского возврат": document.getElementById('clientReturnNum').value,
    "Содержимое заказа": document.getElementById('orderContent').value,
    "Причина возврата от клиента": document.getElementById('returnReason').value,
    "Вскрыта товарная упаковка?": getRadio('packingOpened'),
    "Повреждена товарная упаковка?": getRadio('packingDamaged'),
    "Повреждение товара?": getRadio('goodDamaged'),
    "Товар БУ?": getRadio('goodUsed'),
    "Фактический размер": document.getElementById('actualSize').value,
    "Комментарии по возврату": document.getElementById('comment').value,
    "Дата проверки": document.getElementById('dateChecked').value,
    "Тикет/акт": document.getElementById('ticket').value,
    "Пересорт": getRadio("peresort"),
    "Отправляем в АСЦ?": getRadio("toASC"),
    "Серийный номер": document.getElementById('serialNum').value,
    "Шк товара": document.getElementById('barcode').value,
    "Результат проверки": document.getElementById('orderResult').value
  };
  try {
    const resp = await fetch(
      "https://heck-evsc.onrender.com/proxy",
      {
        method: "POST",
        body: JSON.stringify(data),
        headers: {"Content-Type": "application/json"}
      }
    );
    const txt = await resp.text();
    if (resp.ok && txt.includes("OK")) {
      showToast("✅ Данные успешно сохранены в Google Таблице!","success");
      document.getElementById('manualForm').reset();
      updateDynamicFields();
    } else {
      showToast("❌ Ошибка при сохранении: "+txt,"error");
    }
  } catch (err) {
    showToast("❌ Ошибка связи с прокси-сервером","error");
  }
}
</script>
</body>
</html>
