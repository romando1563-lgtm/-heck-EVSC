<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Проверка возвратных заказов</title>
<meta name="viewport" content="width=660, initial-scale=1">
<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #f6f8fa;
  color: #1a2340;
  padding: 0;
}
h2 {
  text-align: center; margin-top: 22px;
}
.section {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 4px 38px 0 rgba(163,175,212,0.07), 0 1.5px 6px 0 rgba(90,99,132,0.04);
  padding: 24px 30px; margin: 0 auto 30px auto; max-width: 610px;
}
label {
  font-size: 1.08em;
  display: block;
  margin-top: 16px;
  font-weight: 500;
}
input[type="text"], textarea, input[type="date"] {
  font-size: 1em; border-radius: 6px; border: 1.5px solid #cdd6e6;
  margin-top: 5px; margin-bottom: 0; padding: 8px 10px;
  background: #fafdff; outline:none; transition:border .2s;
  width: 100%; box-sizing: border-box;
}
input[type="text"]:focus, textarea:focus, input[type="date"]:focus {
  border:1.5px solid #0076ec !important;
  box-shadow: 0 2px 10px #c9e6fa3b;
}
textarea { min-height: 44px; }
button, .btn {
  margin-top:22px; font-size:1.08em; border: none;
  background: linear-gradient(90deg,#0076ec 60%,#22b8cf 100%);
  color: #fff; padding: 13px 45px; border-radius: 9px;
  font-weight: 600; letter-spacing: .5px;
  box-shadow: 0 3px 14px 0 rgba(0,34,89,0.07);
  cursor:pointer; transition:background .25s,box-shadow .2s;
}
button:hover, .btn:hover { background:#015a9f; }
.flex-row { display: flex; gap: 20px; margin-top:6px;margin-bottom:2px }
#csvOrdersTable { margin-top:12px; border-collapse: collapse; width:100%; }
#csvOrdersTable th, #csvOrdersTable td {
  border:1px solid #d0deea; padding:6px 8px; font-size:.97em; background:#fcfdfe;
}
#csvOrdersTable tr[data-idx] { cursor:pointer; transition: background 0.18s; }
#csvOrdersTable tr[data-idx]:hover { background: #F1F8FE; }
#modal {
  display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(10,34,80,0.26); justify-content: center; align-items: center; z-index: 9999;
}
#modal .modal-inner {
  background: linear-gradient(150deg, #ffe666 68%, #ffd028 103%);
  color: #361800;
  padding: 42px 45px 30px 45px; min-width:330px; max-width:370px;
  border-radius: 17px;
  box-shadow: 0 7px 34px 0 rgba(90,66,2,0.14);
  font-size: 1.21em;
  font-weight: 600;
  text-align: center;
  border: 2.5px solid #FFEE95;
  letter-spacing:.03em;
}
#modal .modal-inner button {
  background: #fffbe0;
  border: 2px solid #ffc400;
  color: #e79114;
  font-size:1.07em; padding: 8px 31px;
  border-radius: 9px; margin:15px 5px 0 5px; font-weight: 600;
  cursor:pointer; transition:background .15s;
}
#modal .modal-inner button:hover {
  background:#ffe178;
}
@media (max-width:640px){
.section {padding:14px 3vw;}
#modal .modal-inner {min-width:unset;max-width:95vw;}
}
</style>
</head>
<body>
<h2>Проверка возвратных заказов</h2>

<div id="modal">
  <div class="modal-inner">
    <span id="modalText"></span><br>
    <button type="button" onclick="closeModal(true)">Понятно</button>
    <button type="button" onclick="closeModal(false)">Отмена</button>
  </div>
</div>

<div class="section">
  <form id="manualForm" autocomplete="off">
    <label>Номер заказа:<input type="text" id="orderNum" required></label>
    <label>Номер клиентского возврата:<input type="text" id="clientReturnNum" required></label>
    <label>Название СД:<input type="text" id="sdName" required></label>
    <label>Название магазина:<input type="text" id="storeName" required></label>
    <label>Содержимое заказа:<textarea id="orderContent" required></textarea></label>
    <label>Причина возврата от клиента:<textarea id="returnReason"></textarea></label>
    <label>Вскрыта товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingOpened" value="Да" required>Да</label>
      <label><input type="radio" name="packingOpened" value="Нет" required>Нет</label>
    </div>
    <label>Повреждена товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingDamaged" value="Да" required>Да</label>
      <label><input type="radio" name="packingDamaged" value="Нет" required>Нет</label>
    </div>
    <label>Повреждение товара?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodDamaged" value="Да" required>Да</label>
      <label><input type="radio" name="goodDamaged" value="Нет" required>Нет</label>
    </div>
    <label>Товар БУ?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodUsed" value="Да" required>Да</label>
      <label><input type="radio" name="goodUsed" value="Нет" required>Нет</label>
    </div>
    <label>Фактический размер:<input type="text" id="actualSize"></label>
    <label>Комментарии по возврату:<textarea id="comment"></textarea></label>
    <label>Дата проверки:<input type="date" id="dateChecked" required></label>
    <div id="peresortBlock">
      <label>Пересорт:</label>
      <div class="flex-row">
        <label><input type="radio" name="peresort" value="Да" required>Да</label>
        <label><input type="radio" name="peresort" value="Нет" required>Нет</label>
      </div>
    </div>
    <div id="nrpBlock" style="display:none;">
      <label>Есть акт нрп? <span style="color:#e35d00;font-weight: bold">*</span></label>
      <div class="flex-row">
        <label><input type="radio" name="nrp" value="Да">Да</label>
        <label><input type="radio" name="nrp" value="Нет">Нет</label>
      </div>
    </div>
    <label>Отправляем в АСЦ?</label>
    <div class="flex-row">
      <label><input type="radio" name="toASC" value="Да" required>Да</label>
      <label><input type="radio" name="toASC" value="Нет" required>Нет</label>
    </div>
    <div id="serialBlock" style="display:none">
      <label>Серийный номер:<input type="text" id="serialNum"></label>
    </div>
    <label>Шк товара:<input type="text" id="barcode" required></label>
    <label>Результат проверки:<input type="text" id="orderResult"></label>
    <button type="submit" class="btn">Проверить заказ и СОХРАНИТЬ</button>
  </form>
  <div id="msg"></div>
</div>

<div class="section">
  <h4>Массовая загрузка (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>

<script>
// --- auto/mass-upload unchanged, +sd/store (см. твой предыдущий код) ---
let loadedOrders = [];
function norm(val) { return (val||'').replace(/\s/g, '').toLowerCase(); }
function lookupOrder() {
  const num = document.getElementById('orderNum').value;
  const ret = document.getElementById('clientReturnNum').value;
  if (!num && !ret) return null;
  let order = null;
  if (num) order = loadedOrders.find(o => norm(o.orderNum) === norm(num));
  if (!order && ret) order = loadedOrders.find(o => norm(o.clientReturnNum) === norm(ret));
  return order || null;
}
let autofillLock = false;
function tryAutoFillForm() {
  if (autofillLock) return;
  const order = lookupOrder();
  if (!order) return;
  autofillLock = true;
  document.getElementById('orderNum').value = order.orderNum || '';
  document.getElementById('clientReturnNum').value = order.clientReturnNum || '';
  document.getElementById('sdName').value = order.sdName || '';
  document.getElementById('storeName').value = order.storeName || '';
  document.getElementById('orderContent').value = order.orderContent || '';
  document.getElementById('returnReason').value = order.returnReason || '';
  autofillLock = false;
}
['input', 'change'].forEach(ev=>{
  document.getElementById('orderNum').addEventListener(ev, tryAutoFillForm);
  document.getElementById('clientReturnNum').addEventListener(ev, tryAutoFillForm);
});
function fillOrderFromCSV(order) {
  document.getElementById('orderNum').value = order.orderNum || '';
  document.getElementById('clientReturnNum').value = order.clientReturnNum || '';
  document.getElementById('sdName').value = order.sdName || '';
  document.getElementById('storeName').value = order.storeName || '';
  document.getElementById('orderContent').value = order.orderContent || '';
  document.getElementById('returnReason').value = order.returnReason || '';
}
function detectDelimiter(s) {
  let line = s.split(/\r?\n/)[0];
  if (line.indexOf('\t') !== -1) return '\t';
  if (line.indexOf(';') !== -1) return ';';
  return ',';
}
document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    let text = evt.target.result;
    text = text.split(/\r?\n/).filter(line => line.trim().length>0).join('\n');
    let delimiter = detectDelimiter(text);
    const lines = text.split(/\r?\n/).filter(l=>l.trim()!=='');
    const headers = lines[0].split(delimiter).map(h=>h.trim().toLowerCase());
    const idxOrderNum     = headers.findIndex(h=>h === 'номер заказа');
    const idxClientReturn = headers.findIndex(h=>h.indexOf('номер клиентского возврат')===0 || h === 'номер клиентского возврата' || h === 'номер клиетского возврата');
    const idxSdName = headers.findIndex(h=>h.includes('название сд'));
    const idxStoreName = headers.findIndex(h=>h.includes('название магазина'));
    const idxOrderContent = headers.findIndex(h=>h.includes('содержимое заказа'));
    const idxReturnReason = headers.findIndex(h=>h.includes('причина возврата'));
    loadedOrders = [];
    let html = '<table id="csvOrdersTable"><tr>' + lines[0].split(delimiter).map(h=>`<th>${h.trim()}</th>`).join('') + '</tr>';
    for (let i=1; i<lines.length; i++) {
      const row = lines[i].split(delimiter);
      while (row.length < headers.length) row.push('');
      html += `<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      loadedOrders.push({
        orderNum: (row[idxOrderNum]||'').trim(),
        clientReturnNum: (row[idxClientReturn]||'').trim(),
        sdName: (row[idxSdName]||'').trim(),
        storeName: (row[idxStoreName]||'').trim(),
        orderContent: (row[idxOrderContent]||'').trim(),
        returnReason: (row[idxReturnReason]||'').trim()
      });
    }
    html += '</table>';
    document.getElementById('csvOrders').innerHTML = html;
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick = function() {
        const idx = +this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx]);
      }
    });
  };
  reader.readAsText(file, 'utf-8');
});

// --- обновление динамических полей: ticket, serial num, nrp
function updateDynamicFields() {
  // ticket/акт
  let showTicket = getRadio('peresort') === 'да';
  if(document.getElementById('ticketBlock')){
    document.getElementById('ticketBlock').style.display = showTicket ? '' : 'none';
    let ticketEl = document.getElementById('ticket');
    if (ticketEl) ticketEl.required = showTicket;
    if (!showTicket && ticketEl) ticketEl.value = '';
  }
  // сер.номер
  let showSerial = getRadio('toASC') === 'да';
  if(document.getElementById('serialBlock')){
    document.getElementById('serialBlock').style.display = showSerial ? '' : 'none';
    let serialEl = document.getElementById('serialNum');
    if (serialEl) serialEl.required = showSerial;
    if (!showSerial && serialEl) serialEl.value = '';
  }
  // нрп радиокнопки
  let showNrp = getRadio('peresort') === 'да';
  if(document.getElementById('nrpBlock')){
    document.getElementById('nrpBlock').style.display = showNrp ? '' : 'none';
    document.querySelectorAll('input[name="nrp"]').forEach(e => {
      e.required = showNrp;
      if (!showNrp) e.checked = false;
    });
  }
}
['change','input'].forEach(ev=>{
  document.getElementsByName('peresort').forEach(e=>e.addEventListener(ev, updateDynamicFields));
  document.getElementsByName('toASC').forEach(e=>e.addEventListener(ev, updateDynamicFields));
});
updateDynamicFields();

// ================ МОДАЛКА ===============
function showModal(msg, cb) {
  document.getElementById('modalText').textContent = msg;
  document.getElementById('modal').style.display = "flex";
  closeModal.cb = cb;
}
function closeModal(confirm) {
  document.getElementById('modal').style.display = "none";
  if (confirm && typeof closeModal.cb === "function") {
    closeModal.cb();
  }
  closeModal.cb = null;
}
function getRadio(name){
  let e = document.querySelector('input[name="'+name+'"]:checked');
  return e ? e.value.trim().toLowerCase() : "";
}
document.getElementById('manualForm').onsubmit = function(e) {
  e.preventDefault();
  updateDynamicFields();
  const packingOpened  = getRadio("packingOpened");
  const packingDamaged = getRadio("packingDamaged");
  const goodDamaged    = getRadio("goodDamaged");
  const goodUsed       = getRadio("goodUsed");
  const toASC          = getRadio("toASC");
  const peresort       = getRadio("peresort");
  if ((packingOpened==="да" && goodUsed==="да") || (packingDamaged==="да" && goodUsed==="да")) {
    showModal("Положи в ячейку БУ", submitAndSave);
    return false;
  }
  if (peresort === "да") {
    showModal("Положи в пересорт", submitAndSave);
    return false;
  }
  if (toASC === "да") {
    showModal("Положи в АСЦ, после возвращения, определи его в БУ", submitAndSave);
    return false;
  }
  if (goodUsed === "да") {
    showModal("Положи в БУ", submitAndSave);
    return false;
  }
  if (goodDamaged === "да") {
    showModal("Положи в брак", submitAndSave);
    return false;
  }
  if (packingOpened === "да") {
    showModal("Положи в уценку", submitAndSave);
    return false;
  }
  if (packingDamaged === "да") {
    showModal("Положи в уценку", submitAndSave);
    return false;
  }
  if (
    packingOpened === "нет" &&
    packingDamaged === "нет" &&
    goodDamaged === "нет" &&
    goodUsed === "нет" &&
    toASC === "нет" &&
    peresort === "нет"
  ) {
    showModal("Положи в годный", submitAndSave);
    return false;
  }
  submitAndSave();
  return false;
};
// =========== TOAST ==================
function showToast(message, type = "info") {
  const colors = {
    success: "#4caf50",
    error: "#f44336",
    info: "#2196f3"
  };
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.cssText = `
      min-width:220px; max-width:350px; margin-bottom:10px;
      padding: 16px 22px; color: #fff; background: ${colors[type]||'#333'};
      border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-size: 1.12em; font-family: inherit; 
      opacity:0; transition: opacity .3s;
      position: fixed; top: 30px; right: 25px; z-index: 13000;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.style.opacity = "1", 80);
  setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(()=>toast.remove(), 400);
  }, 3400);
}
async function submitAndSave() {
  const data = {
    "Номер заказа": document.getElementById('orderNum').value,
    "Номер клиентского возврата": document.getElementById('clientReturnNum').value,
    "Название СД": document.getElementById('sdName').value,
    "Название магазина": document.getElementById('storeName').value,
    "Содержимое заказа": document.getElementById('orderContent').value,
    "Причина возврата от клиента": document.getElementById('returnReason').value,
    "Вскрыта товарная упаковка?": getRadio('packingOpened'),
    "Повреждена товарная упаковка?": getRadio('packingDamaged'),
    "Повреждение товара?": getRadio('goodDamaged'),
    "Товар БУ?": getRadio('goodUsed'),
    "Фактический размер": document.getElementById('actualSize').value,
    "Комментарии по возврату": document.getElementById('comment').value,
    "Дата проверки": document.getElementById('dateChecked').value,
    "Тикет/акт": document.getElementById('ticket') ? document.getElementById('ticket').value : '',
    "Есть акт нрп?": getRadio('nrp'),
    "Пересорт": getRadio("peresort"),
    "Отправляем в АСЦ?": getRadio("toASC"),
    "Серийный номер": document.getElementById('serialNum') ? document.getElementById('serialNum').value : '',
    "Шк товара": document.getElementById('barcode').value,
    "Результат проверки": document.getElementById('orderResult').value
  };
  try {
    const resp = await fetch(
      "https://heck-evsc.onrender.com/proxy",
      {
        method: "POST",
        body: JSON.stringify(data),
        headers: {"Content-Type": "application/json"}
      }
    );
    const txt = await resp.text();
    if (resp.ok && txt.includes("OK")) {
      showToast("✅ Данные успешно сохранены в Google Таблице!","success");
      document.getElementById('manualForm').reset();
      updateDynamicFields();
    } else {
      showToast("❌ Ошибка при сохранении: "+txt,"error");
    }
  } catch (err) {
    showToast("❌ Ошибка связи с прокси-сервером","error");
  }
}
</script>
</body>
</html>
