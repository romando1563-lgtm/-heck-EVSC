<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</title>
<meta name="viewport" content="width=660, initial-scale=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #1a2340;}
h2 { text-align: center; margin-top: 22px; }
.section { background: #fff; border-radius: 18px; box-shadow: 0 4px 38px 0 #dae5fa22; padding: 24px 30px; margin: 0 auto 30px auto; max-width: 610px;}
label { font-size: 1.08em; display: block; margin-top: 16px; }
input[type="text"], textarea, input[type="date"] {
  font-size: 1em; border-radius: 6px; border: 1.5px solid #cdd6e6;
  margin-top: 5px; margin-bottom: 0; padding: 8px 10px; background: #fafdff; width: 100%; box-sizing: border-box;}
textarea { min-height: 44px;}
.flex-row {display: flex; gap: 20px; margin-top:6px;margin-bottom:2px}
button, .btn {margin-top:22px;font-size:1.08em; border:none;background:linear-gradient(90deg,#0076ec 60%,#22b8cf 100%); color:#fff; padding:13px 45px; border-radius: 9px; font-weight:600;}
button:hover, .btn:hover { background:#015a9f; }
#modal {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,34,80,0.26);justify-content:center;align-items:center;z-index:9999}
#modal .modal-inner {
  background: linear-gradient(150deg, #ffe666 68%, #ffd028 103%);
  color: #361800;
  padding: 42px 45px 30px 45px; min-width:330px; max-width:400px;
  border-radius: 17px; box-shadow: 0 7px 34px 0 rgba(90,66,2,0.14);
  font-size: 1.21em;font-weight: 600;text-align:center; border:2.5px solid #FFEE95;}
#modal .modal-inner button {
  background: #fffbe0;border: 2px solid #ffc400;color: #e79114;
  font-size:1.07em;padding: 8px 31px;border-radius: 9px; margin:15px 5px 0 5px;}
#modal .modal-inner button:hover {background:#ffe178;}
#csvOrdersTable {width:100%; border-collapse:collapse; margin-top:15px;}
#csvOrdersTable th, #csvOrdersTable td {border:1px solid #ddd; padding:8px; text-align:left;}
#csvOrdersTable th {background:#f2f2f2; font-weight:bold;}
#csvOrdersTable tr:hover {background:#f5f5f5; cursor:pointer;}
#csvOrdersTable tr.selected {background:#e3f2fd;}
</style>
</head>
<body>
<h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h2>
<div id="modal">
  <div class="modal-inner">
    <span id="modalText"></span><br>
    <button type="button" onclick="closeModal(true)">–ü–æ–Ω—è—Ç–Ω–æ</button>
    <button type="button" onclick="closeModal(false)">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>
<div class="section">
  <form id="manualForm" autocomplete="off">
    <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:<input type="text" id="orderNum" required></label>
    <label>–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞:<input type="text" id="clientReturnNum" required></label>
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –°–î:<input type="text" id="sdName" required></label>
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:<input type="text" id="storeName" required></label>
    <label>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞:<textarea id="orderContent" required></textarea></label>
    <label>–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:<textarea id="returnReason"></textarea></label>
    <label>–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingOpened" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="packingOpened" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?</label>
    <div class="flex-row">
      <label><input type="radio" name="packingDamaged" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="packingDamaged" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodDamaged" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="goodDamaged" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–¢–æ–≤–∞—Ä –ë–£?</label>
    <div class="flex-row">
      <label><input type="radio" name="goodUsed" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="goodUsed" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä:<input type="text" id="actualSize"></label>
    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É:<textarea id="comment"></textarea></label>
    <label>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:<input type="date" id="dateChecked" required></label>
    <label>–¢–∏–∫–µ—Ç/–∞–∫—Ç:<input type="text" id="ticketAct"></label>
    <label>–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?</label>
    <div class="flex-row">
      <label><input type="radio" name="nrp" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="nrp" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–ü–µ—Ä–µ—Å–æ—Ä—Ç:</label>
    <div class="flex-row">
      <label><input type="radio" name="peresort" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="peresort" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <label>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?</label>
    <div class="flex-row">
      <label><input type="radio" name="toASC" value="–î–∞" required>–î–∞</label>
      <label><input type="radio" name="toASC" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
    </div>
    <div id="serialBlock" style="display:none">
      <label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:<input type="text" id="serialNum"></label>
    </div>
    <label>–®–∫ —Ç–æ–≤–∞—Ä–∞:<input type="text" id="barcode" required></label>
    <label>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:<input type="text" id="orderResult"></label>
    <button type="submit" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ –∏ –°–û–•–†–ê–ù–ò–¢–¨</button>
  </form>
  <div id="msg"></div>
</div>
<div class="section">
  <h4>–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>
<script>
let loadedOrders = [];
let selectedOrderIndex = -1;

function norm(val){return (val||'').toString().replace(/\s/g,'').toLowerCase();}

function lookupOrder(){
  const num=document.getElementById('orderNum').value.trim();
  const ret=document.getElementById('clientReturnNum').value.trim();
  if(!num&&!ret)return null;
  return loadedOrders.find(order=>
    (num&&norm(order["–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞"])===norm(num))||
    (ret&&norm(order["–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞"])===norm(ret))
  );
}

let autofillLock=false;
function tryAutoFillForm(){
  if(autofillLock)return;
  const order=lookupOrder();
  if(!order)return;
  autofillLock=true;
  
  console.log("–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", order);
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
  const fields = {
    'orderNum': '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞',
    'clientReturnNum': '–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞',
    'sdName': '–ù–∞–∑–≤–∞–Ω–∏–µ –°–î',
    'storeName': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞',
    'orderContent': '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞',
    'returnReason': '–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',
    'actualSize': '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä',
    'comment': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É',
    'dateChecked': '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',
    'ticketAct': '–¢–∏–∫–µ—Ç/–∞–∫—Ç',
    'serialNum': '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä',
    'barcode': '–®–∫ —Ç–æ–≤–∞—Ä–∞',
    'orderResult': '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏'
  };
  
  Object.entries(fields).forEach(([id, key]) => {
    const element = document.getElementById(id);
    if (element && order[key] !== undefined) {
      element.value = order[key] || '';
    }
  });
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
  const radioMapping = {
    "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingOpened",
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingDamaged",
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": "goodDamaged",
    "–¢–æ–≤–∞—Ä –ë–£?": "goodUsed",
    "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": "nrp",
    "–ü–µ—Ä–µ—Å–æ—Ä—Ç": "peresort",
    "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": "toASC"
  };
  
  Object.entries(radioMapping).forEach(([csvField, htmlName]) => {
    const value = order[csvField];
    if (value) {
      const radios = document.querySelectorAll(`input[name="${htmlName}"]`);
      radios.forEach(radio => {
        radio.checked = (radio.value === value);
      });
    }
  });
  
  autofillLock=false;
  updateDynamicFields();
}

['input','change'].forEach(ev=>{
  document.getElementById('orderNum').addEventListener(ev,tryAutoFillForm);
  document.getElementById('clientReturnNum').addEventListener(ev,tryAutoFillForm);
});

function fillOrderFromCSV(order, index){
  console.log("–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏–∑ CSV, –∏–Ω–¥–µ–∫—Å:", index, order);
  
  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏
  document.querySelectorAll('#csvOrdersTable tr.selected').forEach(tr => {
    tr.classList.remove('selected');
  });
  
  // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
  if (index >= 0) {
    const tr = document.querySelector(`#csvOrdersTable tr[data-idx="${index}"]`);
    if (tr) {
      tr.classList.add('selected');
      selectedOrderIndex = index;
    }
  }
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
  const fields = {
    'orderNum': '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞',
    'clientReturnNum': '–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞',
    'sdName': '–ù–∞–∑–≤–∞–Ω–∏–µ –°–î',
    'storeName': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞',
    'orderContent': '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞',
    'returnReason': '–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',
    'actualSize': '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä',
    'comment': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É',
    'dateChecked': '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',
    'ticketAct': '–¢–∏–∫–µ—Ç/–∞–∫—Ç',
    'serialNum': '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä',
    'barcode': '–®–∫ —Ç–æ–≤–∞—Ä–∞',
    'orderResult': '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏'
  };
  
  Object.entries(fields).forEach(([id, key]) => {
    const element = document.getElementById(id);
    if (element && order[key] !== undefined) {
      element.value = order[key] || '';
    }
  });
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
  const radioMapping = {
    "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingOpened",
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingDamaged",
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": "goodDamaged",
    "–¢–æ–≤–∞—Ä –ë–£?": "goodUsed",
    "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": "nrp",
    "–ü–µ—Ä–µ—Å–æ—Ä—Ç": "peresort",
    "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": "toASC"
  };
  
  Object.entries(radioMapping).forEach(([csvField, htmlName]) => {
    const value = order[csvField];
    if (value) {
      const radios = document.querySelectorAll(`input[name="${htmlName}"]`);
      radios.forEach(radio => {
        radio.checked = (radio.value === value);
      });
    }
  });
  
  updateDynamicFields();
}

function detectDelimiter(s){
  let line=s.split(/\r?\n/)[0];
  if(line.indexOf('\t')!==-1)return'\t';
  if(line.indexOf(';')!==-1)return';';
  return',';
}

document.getElementById('csvInput').addEventListener('change',function(e){
  const file=e.target.files[0];
  if(!file)return;
  
  const reader=new FileReader();
  reader.onload=function(evt){
    let text=evt.target.result;
    text=text.split(/\r?\n/).filter(line=>line.trim().length>0).join('\n');
    
    let delimiter=detectDelimiter(text);
    console.log("–û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:", delimiter);
    
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=='');
    if(lines.length===0)return;
    
    const headers=lines[0].split(delimiter).map(h=>h.trim());
    console.log("–ó–∞–≥–æ–ª–æ–≤–∫–∏ CSV:", headers);
    
    loadedOrders=[];
    selectedOrderIndex=-1;
    
    let html = '<table id="csvOrdersTable"><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
    
    for(let i=1;i<lines.length;i++){
      const row=lines[i].split(delimiter);
      while(row.length<headers.length)row.push('');
      
      html+=`<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      
      let order = {};
      for(let j=0;j<headers.length;j++){
        order[headers[j]] = row[j].trim();
      }
      loadedOrders.push(order);
    }
    
    html+='</table>';
    document.getElementById('csvOrders').innerHTML=html;
    
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick=function(){
        const idx=+this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx], idx);
      }
    });
    
    console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${loadedOrders.length}`);
  };
  reader.readAsText(file,'utf-8');
});

function updateDynamicFields(){
  let showSerial=getRadio('toASC')==='–î–∞';
  if(document.getElementById('serialBlock')){
    document.getElementById('serialBlock').style.display=showSerial?'block':'none';
    let serialEl=document.getElementById('serialNum');
    if(serialEl)serialEl.required=showSerial;
    if(!showSerial&&serialEl)serialEl.value='';
  }
}

['change','input'].forEach(ev=>{
  document.getElementsByName('peresort').forEach(e=>e.addEventListener(ev,updateDynamicFields));
  document.getElementsByName('toASC').forEach(e=>e.addEventListener(ev,updateDynamicFields));
});

updateDynamicFields();

function showModal(msg,cb){
  document.getElementById('modalText').textContent=msg;
  document.getElementById('modal').style.display="flex";
  closeModal.cb=cb;
}

function closeModal(confirm){
  document.getElementById('modal').style.display="none";
  if(confirm&&typeof closeModal.cb==="function"){closeModal.cb();}
  closeModal.cb=null;
}

function getRadio(name){
  let e=document.querySelector('input[name="'+name+'"]:checked');
  return e?e.value.trim():"";
}

document.getElementById('manualForm').onsubmit=function(e){
  e.preventDefault();
  updateDynamicFields();
  
  const actNrp=getRadio("nrp");
  if(actNrp==="–î–∞"){showModal("–ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",submitAndSave);return false;}
  
  const packingOpened=getRadio("packingOpened");
  const packingDamaged=getRadio("packingDamaged");
  const goodDamaged=getRadio("goodDamaged");
  const goodUsed=getRadio("goodUsed");
  const toASC=getRadio("toASC");
  const peresort=getRadio("peresort");
  
  if((packingOpened==="–î–∞"&&goodUsed==="–î–∞")||(packingDamaged==="–î–∞"&&goodUsed==="–î–∞")){
    showModal("–ü–æ–ª–æ–∂–∏ –≤ —è—á–µ–π–∫—É –ë–£",submitAndSave);return false;}
  if(peresort==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ –ø–µ—Ä–µ—Å–æ—Ä—Ç",submitAndSave);return false;}
  if(toASC==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ –ê–°–¶, –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è, –æ–ø—Ä–µ–¥–µ–ª–∏ –µ–≥–æ –≤ –ë–£",submitAndSave);return false;}
  if(goodUsed==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ –ë–£",submitAndSave);return false;}
  if(goodDamaged==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ –±—Ä–∞–∫",submitAndSave);return false;}
  if(packingOpened==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ —É—Ü–µ–Ω–∫—É",submitAndSave);return false;}
  if(packingDamaged==="–î–∞"){showModal("–ü–æ–ª–æ–∂–∏ –≤ —É—Ü–µ–Ω–∫—É",submitAndSave);return false;}
  if(packingOpened==="–ù–µ—Ç"&&packingDamaged==="–ù–µ—Ç"&&goodDamaged==="–ù–µ—Ç"&&goodUsed==="–ù–µ—Ç"&&toASC==="–ù–µ—Ç"&&peresort==="–ù–µ—Ç"){
    showModal("–ü–æ–ª–æ–∂–∏ –≤ –≥–æ–¥–Ω—ã–π",submitAndSave);return false;}
  
  submitAndSave();
  return false;
};

function showToast(message,type="info"){
  const colors={success:"#4caf50",error:"#f44336",info:"#2196f3"};
  const toast=document.createElement("div");
  toast.textContent=message;
  toast.style.cssText=`
    min-width:220px; max-width:350px; margin-bottom:10px;
    padding: 16px 22px; color: #fff; background: ${colors[type]||'#333'};
    border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-size: 1.12em; font-family: inherit; 
    opacity:0; transition: opacity .3s;
    position: fixed; top: 30px; right: 25px; z-index: 13000;
  `;
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity="1",80);
  setTimeout(()=>{toast.style.opacity="0";setTimeout(()=>toast.remove(),400);},3400);
}

async function submitAndSave(){
  console.log("=== –ù–ê–ß–ê–õ–û –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• ===");
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –¢–û–ß–ù–û–ú –ø–æ—Ä—è–¥–∫–µ –∫–∞–∫ –≤ Excel
  const data = {
    "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞": document.getElementById('orderNum').value.trim(),
    "–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞": document.getElementById('clientReturnNum').value.trim(),
    "–ù–∞–∑–≤–∞–Ω–∏–µ –°–î": document.getElementById('sdName').value.trim(),
    "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞": document.getElementById('storeName').value.trim(),
    "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞": document.getElementById('orderContent').value.trim(),
    "–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞": document.getElementById('returnReason').value.trim(),
    "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": getRadio('packingOpened'),
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": getRadio('packingDamaged'),
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": getRadio('goodDamaged'),
    "–¢–æ–≤–∞—Ä –ë–£?": getRadio('goodUsed'),
    "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä": document.getElementById('actualSize').value.trim(), // 11-–µ –ø–æ–ª–µ - –í–ê–ñ–ù–û!
    "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É": document.getElementById('comment').value.trim(),
    "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏": document.getElementById('dateChecked').value,
    "–¢–∏–∫–µ—Ç/–∞–∫—Ç": document.getElementById('ticketAct').value.trim(),
    "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": getRadio('nrp'),
    "–ü–µ—Ä–µ—Å–æ—Ä—Ç": getRadio("peresort"),
    "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": getRadio("toASC"),
    "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä": document.getElementById('serialNum').value.trim(),
    "–®–∫ —Ç–æ–≤–∞—Ä–∞": document.getElementById('barcode').value.trim(),
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏": document.getElementById('orderResult').value.trim()
  };
  
  // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï 20 –ø–æ–ª–µ–π
  console.log("=== –ü–†–û–í–ï–†–ö–ê –í–°–ï–• 20 –ü–û–õ–ï–ô ===");
  const expectedOrder = [
    "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞",                    // 1 (A)
    "–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞",      // 2 (B)
    "–ù–∞–∑–≤–∞–Ω–∏–µ –°–î",                     // 3 (C)
    "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",               // 4 (D)
    "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞",               // 5 (E)
    "–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞",     // 6 (F)
    "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?",      // 7 (G)
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?",   // 8 (H)
    "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?",             // 9 (I)
    "–¢–æ–≤–∞—Ä –ë–£?",                       // 10 (J)
    "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä",              // 11 (K) ‚Üê –í–ù–ò–ú–ê–ù–ò–ï!
    "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É",         // 12 (L)
    "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏",                   // 13 (M)
    "–¢–∏–∫–µ—Ç/–∞–∫—Ç",                       // 14 (N)
    "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?",                   // 15 (O)
    "–ü–µ—Ä–µ—Å–æ—Ä—Ç",                        // 16 (P)
    "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?",               // 17 (Q)
    "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä",                  // 18 (R)
    "–®–∫ —Ç–æ–≤–∞—Ä–∞",                       // 19 (S)
    "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏"               // 20 (T)
  ];
  
  let allFieldsPresent = true;
  expectedOrder.forEach((field, index) => {
    const value = data[field] !== undefined ? `"${data[field]}"` : "(–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)";
    console.log(`${index + 1}. ${field}: ${value}`);
    
    if (data[field] === undefined) {
      console.error(`‚ùå –ü–û–õ–ï –û–¢–°–£–¢–°–¢–í–£–ï–¢: ${field}`);
      allFieldsPresent = false;
    }
  });
  
  if (!allFieldsPresent) {
    showToast("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö","error");
    return;
  }
  
  console.log("‚úÖ –í—Å–µ 20 –ø–æ–ª–µ–π –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç");
  console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–π JSON:", JSON.stringify(data, null, 2));
  
  try {
    showToast("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...", "info");
    
    const response = await fetch("https://heck-evsc.onrender.com/proxy", {
      method: "POST",
      body: JSON.stringify(data),
      headers: {
        "Content-Type": "application/json"
      }
    });
    
    const responseText = await response.text();
    console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", responseText);
    
    let responseData;
    try {
      responseData = JSON.parse(responseText);
    } catch (e) {
      responseData = { message: responseText };
    }
    
    if (response.ok) {
      if (responseData.status === "success" || responseText.includes("OK") || responseText.includes("success")) {
        showToast("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!", "success");
        
        // –£–¥–∞–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
        if (selectedOrderIndex >= 0 && loadedOrders.length > 0) {
          loadedOrders.splice(selectedOrderIndex, 1);
          selectedOrderIndex = -1;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
          const table = document.querySelector('#csvOrdersTable');
          if (table && table.rows.length > selectedOrderIndex + 2) {
            table.deleteRow(selectedOrderIndex + 1);
          }
        }
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(() => {
          document.getElementById('manualForm').reset();
          updateDynamicFields();
          showToast("‚úÖ –§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.", "success");
        }, 1000);
        
      } else {
        showToast(`‚ùå –û—à–∏–±–∫–∞: ${responseData.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`, "error");
      }
    } else {
      showToast(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${responseData.message || responseText}`, "error");
    }
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º:", error);
    showToast("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
  }
}
</script>
</body>
</html>
