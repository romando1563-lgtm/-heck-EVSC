<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</title>
    <meta name="viewport" content="width=660, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #1a2340; margin: 0; padding: 20px;}
        h2 { text-align: center; margin-top: 22px; }
        .section { background: #fff; border-radius: 18px; box-shadow: 0 4px 38px 0 #dae5fa22; padding: 24px 30px; margin: 0 auto 30px auto; max-width: 610px;}
        label { font-size: 1.08em; display: block; margin-top: 16px; }
        input[type="text"], textarea, input[type="date"] {
          font-size: 1em; border-radius: 6px; border: 1.5px solid #cdd6e6;
          margin-top: 5px; margin-bottom: 0; padding: 8px 10px; background: #fafdff; width: 100%; box-sizing: border-box;}
        textarea { min-height: 44px;}
        .flex-row {display: flex; gap: 20px; margin-top:6px;margin-bottom:2px}
        button, .btn {margin-top:22px;font-size:1.08em; border:none;background:linear-gradient(90deg,#0076ec 60%,#22b8cf 100%); color:#fff; padding:13px 45px; border-radius: 9px; font-weight:600; cursor: pointer;}
        button:hover, .btn:hover { background:#015a9f; }
        #modal {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,34,80,0.26);justify-content:center;align-items:center;z-index:9999}
        #modal .modal-inner {
          background: linear-gradient(150deg, #ffe666 68%, #ffd028 103%);
          color: #361800;
          padding: 42px 45px 30px 45px; min-width:330px; max-width:400px;
          border-radius: 17px; box-shadow: 0 7px 34px 0 rgba(90,66,2,0.14);
          font-size: 1.21em;font-weight: 600;text-align:center; border:2.5px solid #FFEE95;}
        #modal .modal-inner button {
          background: #fffbe0;border: 2px solid #ffc400;color: #e79114;
          font-size:1.07em;padding: 8px 31px;border-radius: 9px; margin:15px 5px 0 5px; cursor: pointer;}
        #modal .modal-inner button:hover {background:#ffe178;}
        .debug-info {
          background: #f8f9fa;
          border: 1px solid #ddd;
          border-radius: 5px;
          padding: 10px;
          margin-top: 10px;
          font-family: monospace;
          font-size: 0.9em;
          max-height: 200px;
          overflow-y: auto;
          display: none;
        }
        .debug-toggle {
          background: #6c757d;
          color: white;
          border: none;
          padding: 5px 10px;
          border-radius: 3px;
          cursor: pointer;
          font-size: 0.8em;
          margin-top: 10px;
        }
        #csvOrdersTable {width:100%; border-collapse:collapse; margin-top:15px;}
        #csvOrdersTable th, #csvOrdersTable td {border:1px solid #ddd; padding:8px; text-align:left;}
        #csvOrdersTable th {background:#f2f2f2; font-weight:bold;}
        #csvOrdersTable tr:hover {background:#f5f5f5; cursor:pointer;}
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏ */
        #top-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10000;
            align-items: flex-end;
        }
        #status-indicator {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-online {
            background: #4caf50;
            color: white;
        }
        .status-offline {
            background: #f44336;
            color: white;
        }
        .status-updating {
            background: #ff9800;
            color: white;
        }
        .debug-toggle-top {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-toggle-top:hover {
            background: #5a6268;
        }
        
        /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ */
        input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            cursor: pointer;
        }
        label input[type="radio"] {
            margin-top: 0;
            margin-bottom: 0;
        }
        .flex-row label {
            display: flex;
            align-items: center;
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 0;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel */
        .excel-section {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .excel-section h4 {
            margin-top: 0;
            color: #1976d2;
        }
        #excelFile {
            margin: 10px 0;
            width: 100%;
        }
        #checkShippedBtn {
            background: linear-gradient(90deg, #1976d2 60%, #2196f3 100%);
            padding: 10px 20px;
            font-size: 1em;
            margin: 10px 0;
        }
        #checkShippedBtn:hover {
            background: #1565c0;
        }
        #checkShippedBtn:disabled {
            background: #bbdefb;
            cursor: not-allowed;
        }
        #shippedResult {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
        }
        .shipped-yes {
            background: #c8e6c9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            display: block;
        }
        .shipped-no {
            background: #ffcdd2;
            color: #c62828;
            border: 1px solid #ef9a9a;
            display: block;
        }
        .shipped-checking {
            background: #fff3e0;
            color: #ef6c00;
            border: 1px solid #ffcc80;
            display: block;
        }
        .shipped-details {
            margin-top: 10px;
            font-size: 0.9em;
        }
        .shipped-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.7);
            border-radius: 5px;
        }
        .shipped-item {
            padding: 3px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .shipped-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º —Å—Ç–∞—Ç—É—Å–∞ –∏ –∫–Ω–æ–ø–∫–æ–π –æ—Ç–ª–∞–¥–∫–∏ -->
    <div id="top-bar">
        <div id="status-indicator" class="status-offline">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...</div>
        <button type="button" class="debug-toggle-top" onclick="toggleDebug()">–û—Ç–ª–∞–¥–∫–∞</button>
    </div>
    
    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</h2>
    <div id="modal">
        <div class="modal-inner">
            <span id="modalText"></span><br>
            <button type="button" onclick="closeModal(true)">–ü–æ–Ω—è—Ç–Ω–æ</button>
            <button type="button" onclick="closeModal(false)">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    <div class="section">
        <form id="manualForm" autocomplete="off">
            <!-- –ò–∑–º–µ–Ω–µ–Ω–æ –º–µ—Å—Ç–∞–º–∏: —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
            <label>–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞:<input type="text" id="clientReturnNum" required></label>
            <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:<input type="text" id="orderNum" required></label>
            
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –°–î:<input type="text" id="sdName" required></label>
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞:<input type="text" id="storeName" required></label>
            <label>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞:<textarea id="orderContent" required></textarea></label>
            <label>–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:<textarea id="returnReason"></textarea></label>
            <label>–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?</label>
            <div class="flex-row">
                <label><input type="radio" name="packingOpened" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="packingOpened" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?</label>
            <div class="flex-row">
                <label><input type="radio" name="packingDamaged" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="packingDamaged" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?</label>
            <div class="flex-row">
                <label><input type="radio" name="goodDamaged" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="goodDamaged" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–¢–æ–≤–∞—Ä –ë–£?</label>
            <div class="flex-row">
                <label><input type="radio" name="goodUsed" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="goodUsed" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä:<input type="text" id="actualSize"></label>
            <!-- –°–¥–µ–ª–∞–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º -->
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É:<textarea id="comment" required></textarea></label>
            <label>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:<input type="date" id="dateChecked" required></label>
            <label>–¢–∏–∫–µ—Ç/–∞–∫—Ç:<input type="text" id="ticketAct"></label>
            <label>–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?</label>
            <div class="flex-row">
                <label><input type="radio" name="nrp" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="nrp" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–ü–µ—Ä–µ—Å–æ—Ä—Ç:</label>
            <div class="flex-row">
                <label><input type="radio" name="peresort" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="peresort" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <label>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?</label>
            <div class="flex-row">
                <label><input type="radio" name="toASC" value="–î–∞" required>–î–∞</label>
                <label><input type="radio" name="toASC" value="–ù–µ—Ç" required>–ù–µ—Ç</label>
            </div>
            <div id="serialBlock" style="display:none">
                <label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä:<input type="text" id="serialNum"></label>
            </div>
            <label>–®–∫ —Ç–æ–≤–∞—Ä–∞:<input type="text" id="barcode" required></label>
            <label>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:<input type="text" id="orderResult"></label>

            <button type="submit" class="btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ –∏ –°–û–•–†–ê–ù–ò–¢–¨</button>
            <div id="debugInfo" class="debug-info"></div>
        </form>
        <div id="msg"></div>
    </div>
    
    <div class="section">
        <h4>–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (CSV/TSV)</h4>
        <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
        <div id="csvOrders"></div>
    </div>
    
    <!-- –ù–æ–≤–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–≥—Ä—É–∂–µ–Ω" - –≤–Ω–∏–∑—É -->
    <div class="section excel-section">
        <h4>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–≥—Ä—É–∂–µ–Ω"</h4>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ Google –¢–∞–±–ª–∏—Ü–µ</p>
        <input type="file" id="excelFile" accept=".xlsx,.xls">
        <button type="button" id="checkShippedBtn" onclick="updateShippedStatus()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–≥—Ä—É–∂–µ–Ω</button>
        <div id="shippedResult"></div>
    </div>
    <script>
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í–ê–® URL –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù –ù–ò–ñ–ï!
        const GOOGLE_SCRIPT_URL = "https://heck-evsc.onrender.com/proxy";
        const UPDATE_SHIPPED_URL = "https://heck-evsc.onrender.com/proxy/update-shipped";
        const RENDER_STATUS_URL = "https://heck-evsc.onrender.com/";

        let loadedOrders = [];
        let debugEnabled = false;
        let lastDecision = ""; // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ Render
        async function checkRenderStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            
            try {
                const response = await fetch(RENDER_STATUS_URL, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === "online") {
                        statusIndicator.className = "status-online";
                        statusIndicator.textContent = "üü¢ –û–Ω–ª–∞–π–Ω";
                    } else {
                        statusIndicator.className = "status-offline";
                        statusIndicator.textContent = "üî¥ –û—Ñ–ª–∞–π–Ω";
                    }
                } else {
                    statusIndicator.className = "status-offline";
                    statusIndicator.textContent = "üî¥ –û—Ñ–ª–∞–π–Ω";
                }
            } catch (error) {
                statusIndicator.className = "status-offline";
                statusIndicator.textContent = "üî¥ –û—Ñ–ª–∞–π–Ω";
            }
        }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(checkRenderStatus, 30000);
        
        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        checkRenderStatus();

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            const debugEl = document.getElementById('debugInfo');
            debugEl.style.display = debugEnabled ? 'block' : 'none';
            const debugButtons = document.querySelectorAll('.debug-toggle-top');
            debugButtons.forEach(btn => {
                btn.textContent = debugEnabled ? '–°–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–∫—É' : '–û—Ç–ª–∞–¥–∫–∞';
            });
        }

        function debugLog(message) {
            console.log(message);
            if (debugEnabled) {
                const debugInfo = document.getElementById('debugInfo');
                const now = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `<div>[${now}] ${message}</div>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }
        }

        function norm(val){return (val||'').toString().replace(/\s/g,'').toLowerCase();}

        function lookupOrder(){
            const num = document.getElementById('orderNum').value.trim();
            const ret = document.getElementById('clientReturnNum').value.trim();
            if(!num && !ret) return null;
            return loadedOrders.find(order =>
                (num && norm(order["–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞"]) === norm(num)) ||
                (ret && norm(order["–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞"]) === norm(ret))
            );
        }

        let autofillLock = false;
        function tryAutoFillForm(){
            if(autofillLock) return;
            const order = lookupOrder();
            if(!order) return;
            autofillLock = true;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
            const fields = {
                'clientReturnNum': '–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞', // –ò–∑–º–µ–Ω–µ–Ω–æ
                'orderNum': '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', // –ò–∑–º–µ–Ω–µ–Ω–æ
                'sdName': '–ù–∞–∑–≤–∞–Ω–∏–µ –°–î',
                'storeName': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞',
                'orderContent': '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞',
                'returnReason': '–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',
                'actualSize': '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä',
                'comment': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É',
                'dateChecked': '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',
                'ticketAct': '–¢–∏–∫–µ—Ç/–∞–∫—Ç',
                'serialNum': '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä',
                'barcode': '–®–∫ —Ç–æ–≤–∞—Ä–∞',
                'orderResult': '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏'
            };

            Object.entries(fields).forEach(([id, key]) => {
                const element = document.getElementById(id);
                if (element && order[key] !== undefined) {
                    element.value = order[key] || '';
                }
            });

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏
            const radioMapping = {
                "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingOpened",
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingDamaged",
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": "goodDamaged",
                "–¢–æ–≤–∞—Ä –ë–£?": "goodUsed",
                "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": "nrp",
                "–ü–µ—Ä–µ—Å–æ—Ä—Ç": "peresort",
                "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": "toASC"
            };

            Object.entries(radioMapping).forEach(([csvField, htmlName]) => {
                const value = order[csvField];
                if (value) {
                    const radios = document.querySelectorAll(`input[name="${htmlName}"]`);
                    radios.forEach(radio => {
                        if (radio.value === value) radio.checked = true;
                    });
                }
            });

            autofillLock = false;
            updateDynamicFields();
        }

        ['input','change'].forEach(ev => {
            document.getElementById('orderNum').addEventListener(ev, tryAutoFillForm);
            document.getElementById('clientReturnNum').addEventListener(ev, tryAutoFillForm);
        });

        function fillOrderFromCSV(order){
            const fields = {
                'clientReturnNum': '–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞', // –ò–∑–º–µ–Ω–µ–Ω–æ
                'orderNum': '–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', // –ò–∑–º–µ–Ω–µ–Ω–æ
                'sdName': '–ù–∞–∑–≤–∞–Ω–∏–µ –°–î',
                'storeName': '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞',
                'orderContent': '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞',
                'returnReason': '–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞',
                'actualSize': '–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä',
                'comment': '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É',
                'dateChecked': '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏',
                'ticketAct': '–¢–∏–∫–µ—Ç/–∞–∫—Ç',
                'serialNum': '–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä',
                'barcode': '–®–∫ —Ç–æ–≤–∞—Ä–∞',
                'orderResult': '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏'
            };

            Object.entries(fields).forEach(([id, key]) => {
                const element = document.getElementById(id);
                if (element && order[key] !== undefined) {
                    element.value = order[key] || '';
                }
            });

            const radioMapping = {
                "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingOpened",
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": "packingDamaged",
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": "goodDamaged",
                "–¢–æ–≤–∞—Ä –ë–£?": "goodUsed",
                "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": "nrp",
                "–ü–µ—Ä–µ—Å–æ—Ä—Ç": "peresort",
                "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": "toASC"
            };

            Object.entries(radioMapping).forEach(([csvField, htmlName]) => {
                const value = order[csvField];
                if (value) {
                    const radios = document.querySelectorAll(`input[name="${htmlName}"]`);
                    radios.forEach(radio => {
                        if (radio.value === value) radio.checked = true;
                    });
                }
            });

            updateDynamicFields();
        }

        function detectDelimiter(text) {
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            const firstLine = text.split('\n')[0];
            if (firstLine.includes('\t')) return '\t';
            if (firstLine.includes(';')) return ';';
            return ',';
        }

        document.getElementById('csvInput').addEventListener('change', function(e){
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(evt){
                let text = evt.target.result;
                text = text.split(/\r?\n/).filter(line => line.trim().length > 0).join('\n');

                let delimiter = detectDelimiter(text);
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                if(lines.length === 0) return;

                const headers = lines[0].split(delimiter).map(h => h.trim());
                loadedOrders = [];

                let html = '<table id="csvOrdersTable"><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
                for(let i = 1; i < lines.length; i++){
                    const row = lines[i].split(delimiter);
                    while(row.length < headers.length) row.push('');
                    html += `<tr data-idx="${i-1}">${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
                    let order = {};
                    for(let j = 0; j < headers.length; j++){
                        order[headers[j]] = row[j].trim();
                    }
                    loadedOrders.push(order);
                }
                html += '</table>';
                document.getElementById('csvOrders').innerHTML = html;

                document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
                    tr.onclick = function(){
                        const idx = +this.getAttribute('data-idx');
                        fillOrderFromCSV(loadedOrders[idx]);
                    };
                });
            };
            reader.readAsText(file, 'utf-8');
        });

        function updateDynamicFields(){
            let showSerial = getRadio('toASC') === '–î–∞';
            const serialBlock = document.getElementById('serialBlock');
            if(serialBlock){
                serialBlock.style.display = showSerial ? 'block' : 'none';
                let serialEl = document.getElementById('serialNum');
                if(serialEl) serialEl.required = showSerial;
                if(!showSerial && serialEl) serialEl.value = '';
            }
        }

        ['change','input'].forEach(ev => {
            document.querySelectorAll('input[name="peresort"]').forEach(e => e.addEventListener(ev, updateDynamicFields));
            document.querySelectorAll('input[name="toASC"]').forEach(e => e.addEventListener(ev, updateDynamicFields));
        });

        updateDynamicFields();

        function showModal(msg, cb){
            lastDecision = msg; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            document.getElementById('modalText').textContent = msg;
            document.getElementById('modal').style.display = "flex";
            closeModal.cb = cb;
        }

        function closeModal(confirm){
            document.getElementById('modal').style.display = "none";
            if(confirm && typeof closeModal.cb === "function"){ closeModal.cb(); }
            closeModal.cb = null;
        }

        function getRadio(name){
            let e = document.querySelector('input[name="' + name + '"]:checked');
            return e ? e.value.trim() : "";
        }

        document.getElementById('manualForm').onsubmit = function(e){
            e.preventDefault();
            updateDynamicFields();

            const actNrp = getRadio("nrp");
            if(actNrp === "–î–∞"){ 
                showModal("–ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω", submitAndSave); 
                return false; 
            }

            const goodDamaged = getRadio("goodDamaged");
            if(goodDamaged === "–î–∞"){ 
                showModal("–ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Ç–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω", submitAndSave); 
                return false; 
            }

            const toASC = getRadio("toASC");
            if(toASC === "–î–∞"){ 
                showModal("–ü–æ–ª–æ–∂–∏ –≤ –ê–°–¶, –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è, –æ–ø—Ä–µ–¥–µ–ª–∏ –µ–≥–æ –≤ –ë–£", submitAndSave); 
                return false; 
            }

            const packingOpened = getRadio("packingOpened");
            const packingDamaged = getRadio("packingDamaged");
            const goodUsed = getRadio("goodUsed");
            const peresort = getRadio("peresort");

            if((packingOpened === "–î–∞" && goodUsed === "–î–∞") || (packingDamaged === "–î–∞" && goodUsed === "–î–∞")){
                showModal("–ü–æ–ª–æ–∂–∏ –≤ —è—á–µ–π–∫—É –ë–£", submitAndSave); 
                return false;
            }
            if(peresort === "–î–∞"){ 
                showModal("–ü–æ–ª–æ–∂–∏ –≤ –ø–µ—Ä–µ—Å–æ—Ä—Ç", submitAndSave); 
                return false; 
            }
            if(goodUsed === "–î–∞"){ 
                showModal("–ü–æ–ª–æ–∂–∏ –≤ –ë–£", submitAndSave); 
                return false; 
            }
            if(packingOpened === "–î–∞"){ 
                showModal("–ü–æ–ª–æ–∂–∏ –≤ —É—Ü–µ–Ω–∫—É. –ù–∞–Ω–µ—Å–∏ —ç—Ç–∏–∫–µ—Ç–∫—É –£—Ü–µ–Ω–∫–∞", submitAndSave); 
                return false; 
            }
            if(packingDamaged === "–î–∞"){ 
                showModal("–ü–æ–ª–æ–∂–∏ –≤ —É—Ü–µ–Ω–∫—É. –ù–∞–Ω–µ—Å–∏ —ç—Ç–∏–∫–µ—Ç–∫—É –£—Ü–µ–Ω–∫–∞", submitAndSave); 
                return false; 
            }
            if(packingOpened === "–ù–µ—Ç" && packingDamaged === "–ù–µ—Ç" && goodDamaged === "–ù–µ—Ç" && goodUsed === "–ù–µ—Ç" && toASC === "–ù–µ—Ç" && peresort === "–ù–µ—Ç"){
                showModal("–ü–æ–ª–æ–∂–∏ –≤ –≥–æ–¥–Ω—ã–π", submitAndSave); 
                return false;
            }
            submitAndSave();
            return false;
        };

        function showToast(message, type = "info"){
            const colors = {success: "#4caf50", error: "#f44336", info: "#2196f3"};
            const toast = document.createElement("div");
            toast.textContent = message;
            toast.style.cssText = `
                min-width: 220px; max-width: 350px; margin-bottom: 10px;
                padding: 16px 22px; color: #fff; background: ${colors[type] || '#333'};
                border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                font-size: 1.12em; font-family: inherit;
                opacity: 0; transition: opacity .3s;
                position: fixed; top: 30px; right: 25px; z-index: 13000;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.style.opacity = "1", 80);
            setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.remove(), 400); }, 3400);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–≥—Ä—É–∂–µ–Ω" —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –æ—Ç–ª–∞–¥–∫–æ–π
        async function updateShippedStatus() {
            const fileInput = document.getElementById('excelFile');
            const resultDiv = document.getElementById('shippedResult');
            const updateBtn = document.getElementById('checkShippedBtn');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª", "error");
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showToast("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx –∏–ª–∏ .xls)", "error");
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            updateBtn.disabled = true;
            updateBtn.textContent = "–û–±–Ω–æ–≤–ª—è–µ–º...";
            resultDiv.innerHTML = '<div class="shipped-checking">üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≥—Ä—É–∂–µ–Ω...</div>';
            resultDiv.className = "shipped-checking";
            resultDiv.style.display = "block";
            
            try {
                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                const formData = new FormData();
                formData.append('excelFile', file);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
                console.log("=== –û–¢–õ–ê–î–ö–ê ===");
                console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª:", file.name);
                console.log("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:", file.size, "–±–∞–π—Ç");
                console.log("–¢–∏–ø —Ñ–∞–π–ª–∞:", file.type);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                const response = await fetch(UPDATE_SHIPPED_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const textResponse = await response.text();
                console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–µ–∫—Å—Ç):", textResponse);
                console.log("–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:", response.status);
                console.log("–ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:", [...response.headers.entries()]);
                
                let responseData;
                try {
                    responseData = JSON.parse(textResponse);
                    console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (JSON):", responseData);
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e);
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + textResponse);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (responseData.totalChecked !== undefined) {
                    console.log("–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:", responseData.totalChecked);
                    console.log("–û–±–Ω–æ–≤–ª–µ–Ω–æ:", responseData.updatedCount);
                    if (responseData.updatedReturns) {
                        console.log("–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã:", responseData.updatedReturns);
                    }
                    if (responseData.returnNumbers) {
                        console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞:", responseData.returnNumbers);
                    }
                }
                
                if (response.ok && responseData.status === "success") {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    let resultHtml = '';
                    const totalChecked = responseData.totalChecked || 0;
                    const updatedCount = responseData.updatedCount || 0;
                    
                    if (updatedCount > 0) {
                        resultHtml = `
                            <div class="shipped-yes">
                                ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount} –∏–∑ ${totalChecked} –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ "–û—Ç–≥—Ä—É–∂–µ–Ω"
                                <div class="shipped-details">
                                    –í Google –¢–∞–±–ª–∏—Ü–µ —Å–æ–∑–¥–∞–Ω —Å—Ç–æ–ª–±–µ—Ü "–û—Ç–≥—Ä—É–∂–µ–Ω" –∏ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å "–î–∞"
                                </div>
                            </div>
                        `;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
                        if (responseData.updatedReturns && responseData.updatedReturns.length > 0) {
                            let listHtml = '<div class="shipped-list"><strong>–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—Ç—ã:</strong>';
                            responseData.updatedReturns.forEach(returnNum => {
                                listHtml += `<div class="shipped-item">‚Ä¢ ${returnNum}</div>`;
                            });
                            listHtml += '</div>';
                            resultHtml += listHtml;
                        }
                    } else {
                        resultHtml = `
                            <div class="shipped-no">
                                ‚ÑπÔ∏è –°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${totalChecked} –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ
                                <div class="shipped-details">
                                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ–º–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∏–º–µ—é—â–∏–º–∏—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ
                                </div>
                                ${responseData.message ? `<div class="shipped-details">–°–æ–æ–±—â–µ–Ω–∏–µ: ${responseData.message}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    resultDiv.innerHTML = resultHtml;
                    resultDiv.className = updatedCount > 0 ? "shipped-yes" : "shipped-no";
                } else {
                    resultDiv.innerHTML = `
                        <div class="shipped-no">
                            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ${responseData.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                            <div class="shipped-details">–ö–æ–¥ –æ—à–∏–±–∫–∏: ${response.status}</div>
                            <div class="shipped-details">–û—Ç–≤–µ—Ç: ${textResponse}</div>
                        </div>
                    `;
                    resultDiv.className = "shipped-no";
                }
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                resultDiv.innerHTML = `
                    <div class="shipped-no">
                        ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ${error.message}
                    </div>
                `;
                resultDiv.className = "shipped-no";
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                updateBtn.disabled = false;
                updateBtn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç–≥—Ä—É–∂–µ–Ω";
            }
        }

        async function submitAndSave(){
            debugLog("=== –ù–ê–ß–ê–õ–û –û–¢–ü–†–ê–í–ö–ò –î–ê–ù–ù–´–• ===");
            debugLog("–í—Ä–µ–º—è: " + new Date().toISOString());

            // –í—Å–µ 20 –ø–æ–ª–µ–π –≤ —Ç–æ—á–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –∫–∞–∫ –≤ Excel + —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const data = {
                "–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞": document.getElementById('clientReturnNum').value.trim(), // –ò–∑–º–µ–Ω–µ–Ω–æ
                "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞": document.getElementById('orderNum').value.trim(), // –ò–∑–º–µ–Ω–µ–Ω–æ
                "–ù–∞–∑–≤–∞–Ω–∏–µ –°–î": document.getElementById('sdName').value.trim(),
                "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞": document.getElementById('storeName').value.trim(),
                "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞": document.getElementById('orderContent').value.trim(),
                "–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞": document.getElementById('returnReason').value.trim(),
                "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": getRadio('packingOpened'),
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?": getRadio('packingDamaged'),
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?": getRadio('goodDamaged'),
                "–¢–æ–≤–∞—Ä –ë–£?": getRadio('goodUsed'),
                "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä": document.getElementById('actualSize').value.trim(),
                "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É": document.getElementById('comment').value.trim(),
                "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏": document.getElementById('dateChecked').value,
                "–¢–∏–∫–µ—Ç/–∞–∫—Ç": document.getElementById('ticketAct').value.trim(),
                "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?": getRadio('nrp'),
                "–ü–µ—Ä–µ—Å–æ—Ä—Ç": getRadio("peresort"),
                "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?": getRadio("toASC"),
                "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä": document.getElementById('serialNum').value.trim(),
                "–®–∫ —Ç–æ–≤–∞—Ä–∞": document.getElementById('barcode').value.trim(),
                "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏": lastDecision // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            };

            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï 20 –ø–æ–ª–µ–π
            debugLog("=== –ü–†–û–í–ï–†–ö–ê –í–°–ï–• 20 –ü–û–õ–ï–ô ===");
            const expectedOrder = [
                "–ù–æ–º–µ—Ä –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞", "–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ –°–î", // –ò–∑–º–µ–Ω–µ–Ω–æ
                "–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞", "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–∫–∞–∑–∞", "–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞",
                "–í—Å–∫—Ä—ã—Ç–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?", "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ —Ç–æ–≤–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞?",
                "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞?", "–¢–æ–≤–∞—Ä –ë–£?", "–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä",
                "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –≤–æ–∑–≤—Ä–∞—Ç—É", "–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏", "–¢–∏–∫–µ—Ç/–∞–∫—Ç",
                "–ï—Å—Ç—å –∞–∫—Ç –Ω—Ä–ø?", "–ü–µ—Ä–µ—Å–æ—Ä—Ç", "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ê–°–¶?",
                "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–®–∫ —Ç–æ–≤–∞—Ä–∞", "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏"
            ];

            let allFieldsPresent = true;
            expectedOrder.forEach((field, index) => {
                const value = data[field] !== undefined ? `"${data[field]}"` : "(–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ)";
                debugLog(`${index + 1}. ${field}: ${value}`);
                if (data[field] === undefined) {
                    debugLog(`‚ùå –ü–û–õ–ï –û–¢–°–£–¢–°–¢–í–£–ï–¢: ${field}`);
                    allFieldsPresent = false;
                }
            });

            if (!allFieldsPresent) {
                showToast("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã", "error");
                return;
            }

            debugLog("‚úÖ –í—Å–µ 20 –ø–æ–ª–µ–π –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç");

            try {
                debugLog("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞: " + GOOGLE_SCRIPT_URL);
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥
                
                const resp = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(data),
                    headers: {"Content-Type": "application/json"},
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const txt = await resp.text();
                debugLog("üì• –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + txt);

                let responseData;
                try {
                    responseData = JSON.parse(txt);
                } catch(e) {
                    responseData = { message: txt };
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–æ —Ä–∞–∑–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                const isSuccess = resp.ok || 
                                 responseData.status === "success" || 
                                 txt.includes("OK") || 
                                 txt.includes("success") ||
                                 txt.includes("–£—Å–ø–µ—à–Ω–æ");

                if(isSuccess) {
                    showToast("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!", "success");
                    setTimeout(() => {
                        document.getElementById('manualForm').reset();
                        updateDynamicFields();
                        showToast("‚úÖ –§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É.", "success");
                    }, 1000);
                } else {
                    showToast(`‚ùå –û—à–∏–±–∫–∞: ${responseData.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`, "error");
                }
            } catch(err) {
                debugLog("‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: " + err);
                // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–≤—è–∑–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å
                showToast("‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (–≤–æ–∑–º–æ–∂–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞)", "success");
                setTimeout(() => {
                    document.getElementById('manualForm').reset();
                    updateDynamicFields();
                    showToast("‚úÖ –§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞", "success");
                }, 1000);
            }
        }
    </script>
</body>
</html>
