<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Проверка возвратных заказов</title>
<meta name="viewport" content="width=700, initial-scale=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #1a2340;}
.section { background: #fff; border-radius: 18px; box-shadow: 0 4px 32px 0 #dae5fa22; padding: 24px 30px; margin: 0 auto 30px auto; max-width: 690px;}
label { font-size: 1.09em; display: block; margin-top: 16px; }
input[type="text"], textarea, input[type="date"] { font-size: 1em; border-radius: 6px; border: 1.5px solid #cdd6e6; margin-top: 5px; margin-bottom: 0; padding: 8px 10px; background: #fafdff; width: 100%; box-sizing: border-box;}
textarea { min-height: 44px;}
.flex-row {display: flex; gap: 20px; margin-top:6px;margin-bottom:2px}
button, .btn {margin-top:22px;font-size:1.1em; border:none;background:linear-gradient(90deg,#0076ec 60%,#22b8cf 100%); color:#fff; padding:12px 40px; border-radius: 9px; font-weight:600;}
button:hover, .btn:hover { background:#015a9f; }
#csvOrdersTable {border-collapse: collapse; width: 100%; margin-top: 15px;}
#csvOrdersTable th, #csvOrdersTable td {border:1px solid #d0deea; padding:6px 8px; background:#fcfdfe; text-align: left;}
#csvOrdersTable th {background-color: #eef5ff; font-weight: 600;}
#csvOrdersTable tr:hover {background-color: #f0f7ff; cursor: pointer;}
</style>
</head>
<body>
<h2>Проверка возвратных заказов</h2>
<div class="section">
  <form id="mainForm" autocomplete="off">
    <label>Номер заказа:<input id="Номер заказа" type="text" required></label>
    <label>Номер клиентского возврата:<input id="Номер клиентского возврата" type="text" required></label>
    <label>Название СД:<input id="Название СД" type="text" required></label>
    <label>Название магазина:<input id="Название магазина" type="text" required></label>
    <label>Содержимое заказа:<textarea id="Содержимое заказа" required></textarea></label>
    <label>Причина возврата от клиента:<textarea id="Причина возврата от клиента"></textarea></label>

    <!-- Радиокнопки -->
    <label>Вскрыта товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    <label>Повреждена товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    <label>Повреждение товара?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждение товара?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждение товара?" value="Нет" required>Нет</label>
    </div>
    <label>Товар БУ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Товар БУ?" value="Да" required>Да</label>
      <label><input type="radio" name="Товар БУ?" value="Нет" required>Нет</label>
    </div>

    <label>Фактический размер:<input id="Фактический размер" type="text"></label>
    <label>Комментарии по возврату:<textarea id="Комментарии по возврату"></textarea></label>
    <label>Дата проверки:<input id="Дата проверки" type="date" required></label>
    <label>Тикет/акт:<input id="Тикет/акт" type="text"></label>
    <label>Есть акт нрп?</label>
    <div class="flex-row">
      <label><input type="radio" name="Есть акт нрп?" value="Да" required>Да</label>
      <label><input type="radio" name="Есть акт нрп?" value="Нет" required>Нет</label>
    </div>
    <label>Пересорт:</label>
    <div class="flex-row">
      <label><input type="radio" name="Пересорт" value="Да" required>Да</label>
      <label><input type="radio" name="Пересорт" value="Нет" required>Нет</label>
    </div>
    <label>Отправляем в АСЦ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Отправляем в АСЦ?" value="Да" required>Да</label>
      <label><input type="radio" name="Отправляем в АСЦ?" value="Нет" required>Нет</label>
    </div>
    <label>Серийный номер:<input id="Серийный номер" type="text"></label>
    <label>Шк товара:<input id="Шк товара" type="text" required></label>
    <label>Результат проверки:<input id="Результат проверки" type="text"></label>
    <button type="submit" class="btn">Проверить заказ и СОХРАНИТЬ</button>
  </form>
</div>
<div class="section">
  <h4>Массовая загрузка (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>
<script>
let loadedOrders = [];
document.getElementById('csvInput').addEventListener('change', function(e) {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    let text = evt.target.result;
    let delimiter='\t';
    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
    const headers = lines[0].split(delimiter).map(h => h.trim());
    loadedOrders = [];
    let html = '<table id="csvOrdersTable"><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
    for(let i=1; i<lines.length; i++) {
      const row=lines[i].split(delimiter);
      while(row.length<headers.length)row.push('');
      html+=`<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      let order = {};
      for(let j=0;j<headers.length;j++){
        order[headers[j]] = row[j]?row[j].trim():"";
      }
      loadedOrders.push(order);
    }
    html += '</table>';
    document.getElementById('csvOrders').innerHTML=html;
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick=function(){
        const idx=+this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx]);
      }
    });
  };
  reader.readAsText(file, 'utf-8');
});

function fillOrderFromCSV(order){
  for (const key in order) {
    var el = document.getElementById(key);
    if (el) {
      if (el.type === 'radio') {
        // Для радиокнопок
        const radioName = el.name;
        const valueToCheck = order[key];
        document.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
          radio.checked = (radio.value === valueToCheck);
        });
      } else {
        // Для обычных полей
        el.value = order[key] || '';
      }
    }
  }
}

// Поддержка select строк mass-upload по номеру заказа/возврата
['input','change'].forEach(ev=>{
  document.getElementById('Номер заказа').addEventListener(ev,tryAutoFillForm);
  document.getElementById('Номер клиентского возврата').addEventListener(ev,tryAutoFillForm);
});

let autofillLock = false;
function norm(val){return (val||'').replace(/\s/g,'').toLowerCase();}
function tryAutoFillForm(){
  if(autofillLock)return;
  const num = document.getElementById('Номер заказа').value.trim();
  const ret = document.getElementById('Номер клиентского возврата').value.trim();
  if(!num&&!ret)return;
  let order = loadedOrders.find(order =>
    (num && norm(order["Номер заказа"]) === norm(num)) ||
    (ret && norm(order["Номер клиентского возврата"]) === norm(ret))
  );
  if (!order) return;
  autofillLock=true;
  fillOrderFromCSV(order);
  autofillLock=false;
}

// Функция получения значения радиокнопок
function getRadio(name){
  let e=document.querySelector('input[name="' + name + '"]:checked');
  return e ? e.value.trim() : "";
}

// Функция получения значения текстового поля
function getField(id){
  const el = document.getElementById(id);
  return el ? el.value.trim() : "";
}

document.getElementById('mainForm').onsubmit = function(e) {
  e.preventDefault();
  
  // Сбор данных из формы
  const formData = {
    "Номер заказа": getField('Номер заказа'),
    "Номер клиентского возврата": getField('Номер клиентского возврата'),
    "Название СД": getField('Название СД'),
    "Название магазина": getField('Название магазина'),
    "Содержимое заказа": getField('Содержимое заказа'),
    "Причина возврата от клиента": getField('Причина возврата от клиента'),
    "Вскрыта товарная упаковка?": getRadio('Вскрыта товарная упаковка?'),
    "Повреждена товарная упаковка?": getRadio('Повреждена товарная упаковка?'),
    "Повреждение товара?": getRadio('Повреждение товара?'),
    "Товар БУ?": getRadio('Товар БУ?'),
    "Фактический размер": getField('Фактический размер'),
    "Комментарии по возврату": getField('Комментарии по возврату'),
    "Дата проверки": getField('Дата проверки'),
    "Тикет/акт": getField('Тикет/акт'),
    "Есть акт нрп?": getRadio('Есть акт нрп?'),
    "Пересорт": getRadio('Пересорт'),
    "Отправляем в АСЦ?": getRadio('Отправляем в АСЦ?'),
    "Серийный номер": getField('Серийный номер'),
    "Шк товара": getField('Шк товара'),
    "Результат проверки": getField('Результат проверки')
  };
  
  // Проверка обязательных полей
  const requiredFields = [
    "Номер заказа",
    "Номер клиентского возврата", 
    "Название СД",
    "Название магазина",
    "Содержимое заказа",
    "Шк товара",
    "Дата проверки"
  ];
  
  for (const field of requiredFields) {
    if (!formData[field]) {
      alert(`Поле "${field}" обязательно для заполнения!`);
      const el = document.getElementById(field);
      if (el) el.focus();
      return;
    }
  }
  
  // Проверка обязательных радиокнопок
  const requiredRadios = [
    {name: "Вскрыта товарная упаковка?", label: "Вскрыта товарная упаковка?"},
    {name: "Повреждена товарная упаковка?", label: "Повреждена товарная упаковка?"},
    {name: "Повреждение товара?", label: "Повреждение товара?"},
    {name: "Товар БУ?", label: "Товар БУ?"},
    {name: "Есть акт нрп?", label: "Есть акт нрп?"},
    {name: "Пересорт", label: "Пересорт"},
    {name: "Отправляем в АСЦ?", label: "Отправляем в АСЦ?"}
  ];
  
  for (const radio of requiredRadios) {
    if (!formData[radio.name]) {
      alert(`Не выбран ответ для: "${radio.label}"`);
      return;
    }
  }
  
  // Отладка: показываем что отправляется
  console.log("Отправляемые данные:", JSON.stringify(formData, null, 2));
  
  // Отправка данных
  fetch("https://heck-evsc.onrender.com/proxy", {
    method: "POST",
    body: JSON.stringify(formData),
    headers: {"Content-Type": "application/json"}
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.text();
  })
  .then(responseText => {
    alert('Данные успешно отправлены!\nОтвет сервера: ' + responseText);
    document.getElementById('mainForm').reset();
  })
  .catch(error => {
    console.error('Ошибка отправки:', error);
    alert('Ошибка отправки данных!\n' + error.message);
  });
};
</script>
</body>
</html>
