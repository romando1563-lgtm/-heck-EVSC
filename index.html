<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Проверка возвратных заказов</title>
<meta name="viewport" content="width=660, initial-scale=1">
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; background: #f6f8fa; color: #1a2340;}
h2 { text-align: center; margin-top: 22px; }
.section { background: #fff; border-radius: 18px; box-shadow: 0 4px 38px 0 #dae5fa22; padding: 24px 30px; margin: 0 auto 30px auto; max-width: 610px;}
label { font-size: 1.08em; display: block; margin-top: 16px; }
input[type="text"], textarea, input[type="date"] {
  font-size: 1em; border-radius: 6px; border: 1.5px solid #cdd6e6;
  margin-top: 5px; margin-bottom: 0; padding: 8px 10px; background: #fafdff; width: 100%; box-sizing: border-box;}
textarea { min-height: 44px;}
.flex-row {display: flex; gap: 20px; margin-top:6px;margin-bottom:2px}
button, .btn {margin-top:22px;font-size:1.08em; border:none;background:linear-gradient(90deg,#0076ec 60%,#22b8cf 100%); color:#fff; padding:13px 45px; border-radius: 9px; font-weight:600;}
button:hover, .btn:hover { background:#015a9f; }
#modal {display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,34,80,0.26);justify-content:center;align-items:center;z-index:9999}
#modal .modal-inner {
  background: linear-gradient(150deg, #ffe666 68%, #ffd028 103%);
  color: #361800;
  padding: 42px 45px 30px 45px; min-width:330px; max-width:400px;
  border-radius: 17px; box-shadow: 0 7px 34px 0 rgba(90,66,2,0.14);
  font-size: 1.21em;font-weight: 600;text-align:center; border:2.5px solid #FFEE95;}
#modal .modal-inner button {
  background: #fffbe0;border: 2px solid #ffc400;color: #e79114;
  font-size:1.07em;padding: 8px 31px;border-radius: 9px; margin:15px 5px 0 5px;}
#modal .modal-inner button:hover {background:#ffe178;}
</style>
</head>
<body>
<h2>Проверка возвратных заказов</h2>
<div id="modal">
  <div class="modal-inner">
    <span id="modalText"></span><br>
    <button type="button" onclick="closeModal(true)">Понятно</button>
    <button type="button" onclick="closeModal(false)">Отмена</button>
  </div>
</div>
<div class="section">
  <form id="manualForm" autocomplete="off">
    <label>Номер заказа:<input type="text" id="Номер заказа" required></label>
    <label>Номер клиентского возврата:<input type="text" id="Номер клиентского возврата" required></label>
    <label>Название СД:<input type="text" id="Название СД" required></label>
    <label>Название магазина:<input type="text" id="Название магазина" required></label>
    <label>Содержимое заказа:<textarea id="Содержимое заказа" required></textarea></label>
    <label>Причина возврата от клиента:<textarea id="Причина возврата от клиента"></textarea></label>
    
    <label>Вскрыта товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Вскрыта товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    
    <label>Повреждена товарная упаковка?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждена товарная упаковка?" value="Нет" required>Нет</label>
    </div>
    
    <label>Повреждение товара?</label>
    <div class="flex-row">
      <label><input type="radio" name="Повреждение товара?" value="Да" required>Да</label>
      <label><input type="radio" name="Повреждение товара?" value="Нет" required>Нет</label>
    </div>
    
    <label>Товар БУ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Товар БУ?" value="Да" required>Да</label>
      <label><input type="radio" name="Товар БУ?" value="Нет" required>Нет</label>
    </div>
    
    <label>Фактический размер:<input type="text" id="Фактический размер"></label>
    <label>Комментарии по возврату:<textarea id="Комментарии по возврату"></textarea></label>
    <label>Дата проверки:<input type="date" id="Дата проверки" required></label>
    
    <!-- ДОБАВЛЕНО: поле Тикет/акт -->
    <label>Тикет/акт:<input type="text" id="Тикет/акт"></label>
    
    <div id="peresortBlock">
      <label>Пересорт:</label>
      <div class="flex-row">
        <label><input type="radio" name="Пересорт" value="Да" required>Да</label>
        <label><input type="radio" name="Пересорт" value="Нет" required>Нет</label>
      </div>
    </div>
    
    <div id="nrpBlock">
      <label>Есть акт нрп? <span style="color:#e35d00;font-weight: bold">*</span></label>
      <div class="flex-row">
        <label><input type="radio" name="Есть акт нрп?" value="Да" required>Да</label>
        <label><input type="radio" name="Есть акт нрп?" value="Нет" required>Нет</label>
      </div>
    </div>
    
    <label>Отправляем в АСЦ?</label>
    <div class="flex-row">
      <label><input type="radio" name="Отправляем в АСЦ?" value="Да" required>Да</label>
      <label><input type="radio" name="Отправляем в АСЦ?" value="Нет" required>Нет</label>
    </div>
    
    <div id="serialBlock" style="display:none">
      <label>Серийный номер:<input type="text" id="Серийный номер"></label>
    </div>
    
    <label>Шк товара:<input type="text" id="Шк товара" required></label>
    <label>Результат проверки:<input type="text" id="Результат проверки"></label>
    
    <button type="submit" class="btn">Проверить заказ и СОХРАНИТЬ</button>
  </form>
  <div id="msg"></div>
</div>
<div class="section">
  <h4>Массовая загрузка (CSV/TSV)</h4>
  <input type="file" id="csvInput" accept=".csv,.tsv,.txt">
  <div id="csvOrders"></div>
</div>
<script>
let loadedOrders = [];

function norm(val){return (val||'').replace(/\s/g,'').toLowerCase();}

function lookupOrder(){
  const num=document.getElementById('Номер заказа').value.trim();
  const ret=document.getElementById('Номер клиентского возврата').value.trim();
  if(!num&&!ret)return null;
  return loadedOrders.find(order=>
    (num&&norm(order["Номер заказа"])===norm(num))||
    (ret&&norm(order["Номер клиентского возврата"])===norm(ret))
  );
}

let autofillLock=false;

function tryAutoFillForm(){
  if(autofillLock)return;
  const order=lookupOrder();
  if(!order)return;
  autofillLock=true;
  
  // Заполняем ВСЕ поля по их ID (которые теперь совпадают с ключами JSON)
  document.getElementById('Номер заказа').value=order["Номер заказа"]||'';
  document.getElementById('Номер клиентского возврата').value=order["Номер клиентского возврата"]||'';
  document.getElementById('Название СД').value=order["Название СД"]||'';
  document.getElementById('Название магазина').value=order["Название магазина"]||'';
  document.getElementById('Содержимое заказа').value=order["Содержимое заказа"]||'';
  document.getElementById('Причина возврата от клиента').value=order["Причина возврата от клиента"]||'';
  document.getElementById('Фактический размер').value=order["Фактический размер"]||'';
  document.getElementById('Комментарии по возврату').value=order["Комментарии по возврату"]||'';
  document.getElementById('Дата проверки').value=order["Дата проверки"]||'';
  document.getElementById('Тикет/акт').value=order["Тикет/акт"]||'';
  document.getElementById('Серийный номер').value=order["Серийный номер"]||'';
  document.getElementById('Шк товара').value=order["Шк товара"]||'';
  document.getElementById('Результат проверки').value=order["Результат проверки"]||'';
  
  // Заполняем радиокнопки
  const radioFields = [
    "Вскрыта товарная упаковка?",
    "Повреждена товарная упаковка?",
    "Повреждение товара?",
    "Товар БУ?",
    "Есть акт нрп?",
    "Пересорт",
    "Отправляем в АСЦ?"
  ];
  
  radioFields.forEach(field => {
    const value = order[field];
    if (value) {
      const radios = document.querySelectorAll(`input[name="${field}"]`);
      radios.forEach(radio => {
        radio.checked = (radio.value === value);
      });
    }
  });
  
  autofillLock=false;
  updateDynamicFields();
}

['input','change'].forEach(ev=>{
  document.getElementById('Номер заказа').addEventListener(ev,tryAutoFillForm);
  document.getElementById('Номер клиентского возврата').addEventListener(ev,tryAutoFillForm);
});

function fillOrderFromCSV(order){
  // Аналогично tryAutoFillForm, но без блокировки
  document.getElementById('Номер заказа').value=order["Номер заказа"]||'';
  document.getElementById('Номер клиентского возврата').value=order["Номер клиентского возврата"]||'';
  document.getElementById('Название СД').value=order["Название СД"]||'';
  document.getElementById('Название магазина').value=order["Название магазина"]||'';
  document.getElementById('Содержимое заказа').value=order["Содержимое заказа"]||'';
  document.getElementById('Причина возврата от клиента').value=order["Причина возврата от клиента"]||'';
  document.getElementById('Фактический размер').value=order["Фактический размер"]||'';
  document.getElementById('Комментарии по возврату').value=order["Комментарии по возврату"]||'';
  document.getElementById('Дата проверки').value=order["Дата проверки"]||'';
  document.getElementById('Тикет/акт').value=order["Тикет/акт"]||'';
  document.getElementById('Серийный номер').value=order["Серийный номер"]||'';
  document.getElementById('Шк товара').value=order["Шк товара"]||'';
  document.getElementById('Результат проверки').value=order["Результат проверки"]||'';
  
  const radioFields = [
    "Вскрыта товарная упаковка?",
    "Повреждена товарная упаковка?",
    "Повреждение товара?",
    "Товар БУ?",
    "Есть акт нрп?",
    "Пересорт",
    "Отправляем в АСЦ?"
  ];
  
  radioFields.forEach(field => {
    const value = order[field];
    if (value) {
      const radios = document.querySelectorAll(`input[name="${field}"]`);
      radios.forEach(radio => {
        radio.checked = (radio.value === value);
      });
    }
  });
  
  updateDynamicFields();
}

function detectDelimiter(s){
  let line=s.split(/\r?\n/)[0];
  if(line.indexOf('\t')!==-1)return'\t';
  if(line.indexOf(';')!==-1)return';';
  return',';
}

document.getElementById('csvInput').addEventListener('change',function(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(evt){
    let text=evt.target.result;
    text=text.split(/\r?\n/).filter(line=>line.trim().length>0).join('\n');
    let delimiter=detectDelimiter(text);
    const lines=text.split(/\r?\n/).filter(l=>l.trim()!=='');
    const headers=lines[0].split(delimiter).map(h=>h.trim());
    loadedOrders=[];
    let html = '<table id="csvOrdersTable"><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr>';
    for(let i=1;i<lines.length;i++){
      const row=lines[i].split(delimiter);
      while(row.length<headers.length)row.push('');
      html+=`<tr data-idx="${i-1}">${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`;
      let order = {};
      for(let j=0;j<headers.length;j++){
        order[headers[j]] = row[j].trim();
      }
      loadedOrders.push(order);
    }
    html+='</table>';
    document.getElementById('csvOrders').innerHTML=html;
    document.querySelectorAll('#csvOrdersTable tr[data-idx]').forEach(function(tr){
      tr.onclick=function(){
        const idx=+this.getAttribute('data-idx');
        fillOrderFromCSV(loadedOrders[idx]);
      }
    });
  };
  reader.readAsText(file,'utf-8');
});

function updateDynamicFields(){
  let showSerial=getRadio('Отправляем в АСЦ?')==='да';
  if(document.getElementById('serialBlock')){
    document.getElementById('serialBlock').style.display=showSerial?'':'none';
    let serialEl=document.getElementById('Серийный номер');
    if(serialEl)serialEl.required=showSerial;
    if(!showSerial&&serialEl)serialEl.value='';
  }
  document.querySelectorAll('input[name="Есть акт нрп?"]').forEach(e=>{e.required=true;});
}

['change','input'].forEach(ev=>{
  document.getElementsByName('Пересорт').forEach(e=>e.addEventListener(ev,updateDynamicFields));
  document.getElementsByName('Отправляем в АСЦ?').forEach(e=>e.addEventListener(ev,updateDynamicFields));
});

updateDynamicFields();

function showModal(msg,cb){
  document.getElementById('modalText').textContent=msg;
  document.getElementById('modal').style.display="flex";
  closeModal.cb=cb;
}

function closeModal(confirm){
  document.getElementById('modal').style.display="none";
  if(confirm&&typeof closeModal.cb==="function"){closeModal.cb();}
  closeModal.cb=null;
}

function getRadio(name){
  let e=document.querySelector('input[name="'+name+'"]:checked');
  return e?e.value.trim().toLowerCase():"";
}

document.getElementById('manualForm').onsubmit=function(e){
  e.preventDefault();
  updateDynamicFields();
  
  const actNrp=getRadio("Есть акт нрп?");
  if(actNrp==="да"){showModal("Заказ должен быть утилизирован",submitAndSave);return false;}
  
  const packingOpened=getRadio("Вскрыта товарная упаковка?");
  const packingDamaged=getRadio("Повреждена товарная упаковка?");
  const goodDamaged=getRadio("Повреждение товара?");
  const goodUsed=getRadio("Товар БУ?");
  const toASC=getRadio("Отправляем в АСЦ?");
  const peresort=getRadio("Пересорт");
  
  if((packingOpened==="да"&&goodUsed==="да")||(packingDamaged==="да"&&goodUsed==="да")){
    showModal("Положи в ячейку БУ",submitAndSave);return false;}
  if(peresort==="да"){showModal("Положи в пересорт",submitAndSave);return false;}
  if(toASC==="да"){showModal("Положи в АСЦ, после возвращения, определи его в БУ",submitAndSave);return false;}
  if(goodUsed==="да"){showModal("Положи в БУ",submitAndSave);return false;}
  if(goodDamaged==="да"){showModal("Положи в брак",submitAndSave);return false;}
  if(packingOpened==="да"){showModal("Положи в уценку",submitAndSave);return false;}
  if(packingDamaged==="да"){showModal("Положи в уценку",submitAndSave);return false;}
  
  if(packingOpened==="нет"&&packingDamaged==="нет"&&goodDamaged==="нет"&&goodUsed==="нет"&&toASC==="нет"&&peresort==="нет"){
    showModal("Положи в годный",submitAndSave);return false;}
  
  submitAndSave();
  return false;
};

function showToast(message,type="info"){
  const colors={success:"#4caf50",error:"#f44336",info:"#2196f3"};
  const toast=document.createElement("div");
  toast.textContent=message;
  toast.style.cssText=`
    min-width:220px; max-width:350px; margin-bottom:10px;
    padding: 16px 22px; color: #fff; background: ${colors[type]||'#333'};
    border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    font-size: 1.12em; font-family: inherit; 
    opacity:0; transition: opacity .3s;
    position: fixed; top: 30px; right: 25px; z-index: 13000;
  `;
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity="1",80);
  setTimeout(()=>{toast.style.opacity="0";setTimeout(()=>toast.remove(),400);},3400);
}

async function submitAndSave(){
  // ВАЖНО: Теперь ключи объекта совпадают с ID полей в HTML и ожиданиями Apps Script
  const data = {
    "Номер заказа": document.getElementById('Номер заказа').value,
    "Номер клиентского возврата": document.getElementById('Номер клиентского возврата').value,
    "Название СД": document.getElementById('Название СД').value,
    "Название магазина": document.getElementById('Название магазина').value,
    "Содержимое заказа": document.getElementById('Содержимое заказа').value,
    "Причина возврата от клиента": document.getElementById('Причина возврата от клиента').value,
    "Вскрыта товарная упаковка?": getRadio('Вскрыта товарная упаковка?'),
    "Повреждена товарная упаковка?": getRadio('Повреждена товарная упаковка?'),
    "Повреждение товара?": getRadio('Повреждение товара?'),
    "Товар БУ?": getRadio('Товар БУ?'),
    "Фактический размер": document.getElementById('Фактический размер').value,
    "Комментарии по возврату": document.getElementById('Комментарии по возврату').value,
    "Дата проверки": document.getElementById('Дата проверки').value,
    "Тикет/акт": document.getElementById('Тикет/акт').value, // ← Добавлено поле
    "Есть акт нрп?": getRadio('Есть акт нрп?'),
    "Пересорт": getRadio("Пересорт"),
    "Отправляем в АСЦ?": getRadio("Отправляем в АСЦ?"),
    "Серийный номер": document.getElementById('Серийный номер').value,
    "Шк товара": document.getElementById('Шк товара').value,
    "Результат проверки": document.getElementById('Результат проверки').value
  };
  
  console.log("ОТПРАВЛЯЕМЫЕ ДАННЫЕ:", data);
  
  try {
    const resp = await fetch(
      "https://heck-evsc.onrender.com/proxy",
      {
        method: "POST",
        body: JSON.stringify(data),
        headers: {"Content-Type": "application/json"}
      }
    );
    const txt = await resp.text();
    console.log("ОТВЕТ СЕРВЕРА:", txt);
    
    if(resp.ok && (txt.includes("OK") || txt.includes("success"))){
      showToast("✅ Данные успешно сохранены в Google Таблицу!","success");
      document.getElementById('manualForm').reset();
      updateDynamicFields();
    }else{
      showToast("❌ Ошибка при сохранении: "+txt,"error");
    }
  }catch(err){
    console.error("Ошибка связи:", err);
    showToast("❌ Ошибка связи с прокси-сервером","error");
  }
}
</script>
</body>
</html>
